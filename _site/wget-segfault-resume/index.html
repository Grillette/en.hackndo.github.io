<!doctype html>
<html lang="fr-fr" class="no-js">

  <head>
    <link href="http://gmpg.org/xfn/11" rel="profile" hreflang="fr">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
    <meta name="google-site-verification" content="JeRPv2CEcpONAy8C7dMr1nzjlpZxlxYCtt2PnuQ78g8" />
    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  
    <title>
      
        wget - segfault: Résumé - hackndo
      
    </title>

	<link rel="stylesheet" href="/assets/css/style.css?v=1.13"> <!-- Resource style -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Signika:600"> <!-- Logo font -->
    <script src="/assets/js/modernizr.js"></script> <!-- Modernizr -->
    
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/icones/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/icones/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/icones/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/icones/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/icones/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/icones/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/icones/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icones/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icones/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icones/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icones/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/icones/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icones/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/res/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/icones/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
  	
	<!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hackndo" />

    <!-- Twitter card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@hackanddo" />
    <meta name="twitter:creator" content="@hackanddo" />
    <meta name="twitter:title" content="wget - segfault: Résumé" />
    <meta name="twitter:description" content="Un segfault dans wget ? Analyse technique du pourquoi du comment pour proposer un patch !" />
    
    <meta name="twitter:image" content="http://localhost:4000/assets/uploads/2015/06/WGETSEGFAULT.jpg" />
    
  
    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  
      ga('create', 'UA-80312745-1', 'auto');
      ga('send', 'pageview');
  
    </script>
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="wget - segfault: Résumé" />
<meta name="author" content="Pixis" />
<meta property="og:locale" content="fr_FR" />
<meta name="description" content="Un segfault dans wget ? Analyse technique du pourquoi du comment pour proposer un patch !" />
<meta property="og:description" content="Un segfault dans wget ? Analyse technique du pourquoi du comment pour proposer un patch !" />
<link rel="canonical" href="http://localhost:4000/wget-segfault-resume/" />
<meta property="og:url" content="http://localhost:4000/wget-segfault-resume/" />
<meta property="og:site_name" content="hackndo" />
<meta property="og:image" content="http://localhost:4000/assets/uploads/2015/06/WGETSEGFAULT.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-06-11T00:00:00+02:00" />
<script type="application/ld+json">
{"image":"http://localhost:4000/assets/uploads/2015/06/WGETSEGFAULT.jpg","@type":"BlogPosting","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icones/logo.png"},"name":"Pixis"},"url":"http://localhost:4000/wget-segfault-resume/","headline":"wget - segfault: Résumé","dateModified":"2015-06-11T00:00:00+02:00","datePublished":"2015-06-11T00:00:00+02:00","author":{"@type":"Person","name":"Pixis"},"description":"Un segfault dans wget ? Analyse technique du pourquoi du comment pour proposer un patch !","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/wget-segfault-resume/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <header class="cd-main-header">
    <a href="/" class="cd-logo"><img src="/assets/icones/logo.png" /> <span class="cd-logo-title">hackndo</span></a>
		
    <a href="#0" class="cd-nav-trigger">Menu<span></span></a>

</header> <!-- .cd-main-header -->
    <main class="cd-main-content">
		<nav class="cd-side-nav">
            <div class="sidebar-about">
    <h1>
        <img id="site-logo" src="/assets/icones/logo.png" alt="logo" title="logo" />
        <a class="sidebar-title" href="/">
        hackndo
        </a>
    </h1>
    <p class="lead">Think out of the box</p>
</div>

<ul>
    <li class="cd-label">Blog</li>
    <li class="">
        <a href="/">Home</a>
    </li>
    
    
        
            
        
    
        
            
                <li class="">
                    <a href="/about/">À propos</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/archives/">Archives</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/contact/">Me contacter</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/disclaimer/">Disclaimer</a>
                </li>
            
        
    
        
    
        
            
        
    
        
            
                <li class="">
                    <a href="/projects/">Projets</a>
                </li>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
    
        
    
</ul>
<ul>
    <li class="cd-label">Liens</li>
    <li><a href="https://www.dailysecurity.fr/" target="_blank">Blog de Geluchat</a></li>
    <li><a href="http://lsdsecdaemon.com" target="_blank">Blog de Th3_l5D</a></li>
    <li><a href="http://inf0sec.fr" target="_blank">Blog de Matthieu</a></li>
</ul>
<p class="sidebar-copyright">&copy; 2019. Tous droits réservés.</p>
<div class="sidebar-social">
<ul>
  <li><a href="https://twitter.com/HackAndDo" title="Twitter" target="_blank"><img alt="Twitter" title="Twitter" src="/assets/icones/social/twitter.png" /></a></li>
  <li><a href="https://github.com/hackndo" title="Github" target="_blank"><img title="Github" alt="Github" src="/assets/icones/social/github.png" /></a></li>
  <li><a href="https://www.youtube.com/channel/UC9WYWHLdu9TK-0Hu3wcHJ9g" title="Youtube" target="_blank"><img title="Youtube" alt="Youtube" src="/assets/icones/social/youtube.png" /></a></li>
  <li><a href="https://discord.gg/9At6SUZ" title="Discord" target="_blank"><img title="Discord" alt="Discord" src="/assets/icones/social/discord.png" /></a></li>
  <li><a href="https://www.linkedin.com/in/romainbentz/" title="LinkedIn" target="_blank"><img title="LinkedIn" alt="LinkedIn" src="/assets/icones/social/linkedin.png" /></a></li>
  <li><a href="https://sh.hackndo.com" title="Shell" target="_blank"><img title="Shell" alt="Shell" src="/assets/icones/social/shell.png" /></a></li>
  <li><a href="/feed.xml" title="RSS" target="_blank"><img title="RSS" alt="RSS" src="/assets/icones/social/rss.png" /></a></li>
  <li><a href="https://ko-fi.com/hackndo" title="Ko-Fi" target="_blank"><img title="Ko-Fi" alt="Ko-Fi" src="/assets/icones/social/kofi.gif" /></a></li>
</ul>
</div>
        </nav>

        <div class="content-wrapper">
            <div class="post">
  
  <div class="post-cover">
    <img src="/assets/uploads/2015/06/WGETSEGFAULT.jpg" alt="wget - segfault: Résumé" title="wget - segfault: Résumé" />
  </div>
  
  <h1 class="post-title">wget - segfault: Résumé</h1>
  <div class="post-info">
      <p class="alignleft">11 Jun 2015 <a class="post-comments-count" href="http://http://localhost:4000/wget-segfault-resume/#disqus_thread"></a></p>
      <p class="alignright">Auteur : <strong><a href="https://twitter.com/HackAndDo">Pixis</a></strong></p>
      <div class="keywords">
        <span class="post-tags"><a href="/archives/#user-land"><i class="fas fa-tags"></i> User Land</a><a href="/archives/#linux"><i class="fas fa-tags"></i> Linux</a></span>
      </div>
</div>

  <article>
  <p>Salut à tous, <strong>winw</strong> m’a montré récemment un truc assez sympa. Dans un terminal, tapez la commande</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>wget <span class="nt">-r</span> %3a
Segmentation fault
</code></pre></div></div>

<p>Vous obtiendrez un segfault.</p>

<!--more-->

<p>C’est d’autant plus sympa que wget est un binaire très largement utilisé. Les bugs comme celui-ci se font rares ! On s’est alors demandé ce qu’on pouvait bien en faire, et si on pouvait le corriger. Nous ne nous sommes donc pas arrêtés là, et on a cherché la cause du problème.</p>

<h2 id="environnement-de-debug">Environnement de debug</h2>

<p>Pour cela, nous nous sommes armés de ce bon vieux gdb, ainsi que des sources de la dernière version de wget en date (1.16.3) disponible ici :</p>

<p><a href="http://ftp.gnu.org/gnu/wget/wget-1.16.3.tar.gz">http://ftp.gnu.org/gnu/wget/wget-1.16.3.tar.gz</a></p>

<p>Dans un premier temps, nous avons recompilé le binaire afin d’en avoir une version non strippée et donc avoir accès aux symboles. Dans le dossiers des sources de wget :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./configure <span class="nt">--user-prefix</span><span class="o">=</span>/home/hackndo/wget
<span class="nv">$ </span>make <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>make <span class="nb">install</span>
</code></pre></div></div>

<h2 id="reproduction-du-bug">Reproduction du bug</h2>

<p>Ensuite nous avons provoqué le segfault dans gdb puis affiché la backtrace pour trouver où se situe le problème</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb<span class="nv">$ </span>r <span class="nt">-r</span> %3a
warning: no loadable sections found <span class="k">in </span>added symbol-file system-supplied DSO at 0x7ffff7ffa000
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>

Program received signal SIGSEGV, Segmentation fault.
<span class="nt">-----------------------------------------------------------------------------------------------------------------------</span><span class="o">[</span>regs]
RAX: 0x0000000000000006  RBX: 0x0000000000000000  RBP: 0x000000000065FFE0  RSP: 0x00007FFFFFFFDF10  o d I t s z a p c
RDI: 0x00000000FFFFFFFF  RSI: 0x00007FFFF7FF7000  RDX: 0x00007FFFF799CDF0  RCX: 0x00007FFFF76E59D0  RIP: 0x0000000000421ADB
R8 : 0x00007FFFF7FF7001  R9 : 0x00007FFFF7FE9700  R10: 0x0000000000000000  R11: 0x0000000000000246  R12: 0x000000000065FFB0
R13: 0x000000000065F950  R14: 0x00007FFFFFFFE05A  R15: 0x00007FFFFFFFE060
CS: 0033  DS: 0000  ES: 0000  FS: 0000  GS: 0000  SS: 002B
<span class="nt">-----------------------------------------------------------------------------------------------------------------------</span>
</code></pre></div></div>

<h2 id="recherche-de-la-cause">Recherche de la cause</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">=&gt;</span> 0x421adb &lt;getproxy+27&gt;:  mov    esi,DWORD PTR <span class="o">[</span>rbx+0x18]
   0x421ade &lt;getproxy+30&gt;:  mov    edi,0x44af12
   0x421ae3 &lt;getproxy+35&gt;:  xor    eax,eax
   0x421ae5 &lt;getproxy+37&gt;:  call   0x402f10 &lt;<span class="nb">printf</span>@plt&gt;
   0x421aea &lt;getproxy+42&gt;:  mov    rdi,QWORD PTR <span class="o">[</span>rip+0x23b2bf]        <span class="c"># 0x65cdb0 &lt;opt+304&gt;</span>
   0x421af1 &lt;getproxy+49&gt;:  mov    rsi,QWORD PTR <span class="o">[</span>rbx+0x10]
   0x421af5 &lt;getproxy+53&gt;:  <span class="nb">test</span>   rdi,rdi
   0x421af8 &lt;getproxy+56&gt;:  je     0x421b03 &lt;getproxy+67&gt;
<span class="nt">-----------------------------------------------------------------------------------------------------------------------------</span>
0x0000000000421adb <span class="k">in </span>getproxy <span class="o">()</span>
gdb<span class="nv">$ </span>bt
<span class="c">#0  0x0000000000421adb in getproxy ()</span>
<span class="c">#1  0x00000000004226fa in retrieve_url ()</span>
<span class="c">#2  0x00000000004204a0 in retrieve_tree ()</span>
<span class="c">#3  0x0000000000404168 in main ()</span>
</code></pre></div></div>

<p>Le segfault se produit dans la fonction <code class="highlighter-rouge">getproxy</code> se trouvant dans <strong>retr.c</strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">getproxy</span> <span class="p">(</span><span class="k">struct</span> <span class="n">url</span> <span class="o">*</span><span class="n">u</span><span class="p">)</span>
</code></pre></div></div>

<p>Après quelques petites recherches, on remarque que le pointeur <code class="highlighter-rouge">u</code> sur une structure <code class="highlighter-rouge">url</code> est un pointeur null, et du coup à la ligne</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">no_proxy_match</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">opt</span><span class="p">.</span><span class="n">no_proxy</span><span class="p">))</span>
</code></pre></div></div>

<p>la tentative d’accès au champ <code class="highlighter-rouge">host</code> de la structure provoque le segfault.</p>

<p>Très bien, nous avons isolé la cause du segfault. Cependant, comment se fait-il que le pointeur <code class="highlighter-rouge">u</code> passé à <code class="highlighter-rouge">getproxy</code> soit nul ? Nous remontons alors un peu la backtrace.</p>

<p>Dans <code class="highlighter-rouge">retrieve_url</code>, toujours dans le même fichier</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">uerr_t</span> <span class="n">retrieve_url</span> <span class="p">(</span><span class="k">struct</span> <span class="n">url</span> <span class="o">*</span> <span class="n">orig_parsed</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">origurl</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">file</span><span class="p">,</span>
<span class="kt">char</span> <span class="o">**</span><span class="n">newloc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">refurl</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">bool</span> <span class="n">recursive</span><span class="p">,</span>
<span class="k">struct</span> <span class="n">iri</span> <span class="o">*</span><span class="n">iri</span><span class="p">,</span> <span class="n">bool</span> <span class="n">register_status</span><span class="p">)</span>
</code></pre></div></div>

<p>On voit l’appel à <code class="highlighter-rouge">getproxy</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">proxy</span> <span class="o">=</span> <span class="n">getproxy</span> <span class="p">(</span><span class="n">u</span><span class="p">);</span>
</code></pre></div></div>

<p>Et on voit plus haut que <code class="highlighter-rouge">u</code> est défini comme ceci :</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">url</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="n">orig_parsed</span>
</code></pre></div></div>

<p>En mettant un breakpoint à l’entrée de la fonction <code class="highlighter-rouge">retrieve_url</code>, on se rend compte que le paramètre <code class="highlighter-rouge">orig_parsed</code> est déjà un pointeur nul. On continue et on remonte la backtrace d’un cran, en allant voir la fonction <code class="highlighter-rouge">retrieve_tree</code> située dans le fichier <code class="highlighter-rouge">recur.c</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">uerr_t</span> <span class="n">retrieve_tree</span> <span class="p">(</span><span class="k">struct</span> <span class="n">url</span> <span class="o">*</span><span class="n">start_url_parsed</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iri</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
</code></pre></div></div>

<p>On voit l’appel à la fonction <code class="highlighter-rouge">retrieve_url</code> ici</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">status</span> <span class="o">=</span> <span class="n">retrieve_url</span> <span class="p">(</span><span class="n">url_parsed</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">redirected</span><span class="p">,</span> <span class="n">referer</span><span class="p">,</span>
<span class="o">&amp;</span><span class="n">dt</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</code></pre></div></div>

<p>Nous avons dit que le paramètre <code class="highlighter-rouge">url_parsed</code> était nul. Ce pointeur est défini une ligne au dessus :</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">url</span> <span class="o">*</span><span class="n">url_parsed</span> <span class="o">=</span> <span class="n">url_parse</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">url_err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</code></pre></div></div>

<p>Cette fois-ci, aucun des paramètres passés à <code class="highlighter-rouge">url_parse</code> ne sont nuls. Cette fonction renvoie donc un pointeur nul. En mettant un breakpoint juste après l’appel à cette fonction, on peut voir ce qu’il y a dans <code class="highlighter-rouge">url_err</code> : Le numéro 8.</p>

<p>Le code d’erreur 8 est défini dans le fichier <code class="highlighter-rouge">url.c</code> (dans lequel il y a la fonction <code class="highlighter-rouge">url_parse</code>)</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define PE_INVALID_IPV6_ADDRESS         8
</span></code></pre></div></div>

<p>Effectivement, dans la fonction <code class="highlighter-rouge">url_parse</code>, nous avons la vérification suivante :</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Check if the IPv6 address is valid. */</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ipv6_address</span><span class="p">(</span><span class="n">host_b</span><span class="p">,</span> <span class="n">host_e</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">error_code</span> <span class="o">=</span> <span class="n">PE_INVALID_IPV6_ADDRESS</span><span class="p">;</span>
    <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Continue parsing after the closing ']'. */</span>
</code></pre></div></div>

<p>Je vous rappelle que l’argument que nous avons passé à wget était <code class="highlighter-rouge">-r %3a</code> or <code class="highlighter-rouge">%3a</code> est le code ASCII de <code class="highlighter-rouge">:</code> . En amont, wget a détecté notre <code class="highlighter-rouge">:</code> et a donc considéré que c’était une adresse IPv6. Celle-ci étant invalide, <code class="highlighter-rouge">is_valid_ipv6_address()</code> renvoie <code class="highlighter-rouge">false</code>, et nous avons le code d’erreur. Tout est bien et se passe comme prévu par les développeurs à ce moment là.</p>

<p>L’erreur, c’est dans le fichier <code class="highlighter-rouge">recur.c</code> avec ces lignes :</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">url</span> <span class="o">*</span><span class="n">url_parsed</span> <span class="o">=</span> <span class="n">url_parse</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">url_err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">retrieve_url</span> <span class="p">(</span><span class="n">url_parsed</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">redirected</span><span class="p">,</span> <span class="n">referer</span><span class="p">,</span>
<span class="o">&amp;</span><span class="n">dt</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</code></pre></div></div>

<p>Il n’y a aucune vérification de faite sur le retour de la fonction <code class="highlighter-rouge">url_parse</code>, et le pointeur <code class="highlighter-rouge">url_parsed</code> est utilisé sans vérifier s’il est nul, ou non.</p>

<p>Nous avons donc, logiquement, un segfault. De notre point de vue, cet oubli ne permet aucune exploitation, mais c’était une analyse intéressante. Un fix est de vérifier que la fonction <code class="highlighter-rouge">url_parse</code> a renvoyé un pointeur non nul, de la manière suivante :</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">url</span> <span class="o">*</span><span class="n">url_parsed</span> <span class="o">=</span> <span class="n">url_parse</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">url_err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">url_parsed</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="n">url_error</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">url_err</span><span class="p">);</span>
    <span class="n">logprintf</span> <span class="p">(</span><span class="n">LOG_NOTQUIET</span><span class="p">,</span> <span class="s">"%s: %s.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">url</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="n">xfree</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
    <span class="n">inform_exit_status</span> <span class="p">(</span><span class="n">URLERROR</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">retrieve_url</span> <span class="p">(</span><span class="n">url_parsed</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">redirected</span><span class="p">,</span> <span class="n">referer</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">dt</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
    <span class="c1">// [...]</span>
</code></pre></div></div>

<p>Nous avons d’ailleurs proposé un fix à GNU. Nous verrons s’il sera accepté !</p>

<p>Ce problème n’existe pas si le paramètre <code class="highlighter-rouge">-r</code> est omis, puisque cet oubli de vérification se situe seulement dans le fichier <code class="highlighter-rouge">recur.c</code>, et nulle part ailleurs.</p>

<h2 id="correction-du-bug">Correction du bug</h2>

<p>Nous avons envoyé un fix qui a été accepté et <a href="https://savannah.gnu.org/bugs/?45289#comment5" target="blank">est mergé dans la branche master</a> ! Voilà, une petite contribution au monde libre, ça fait plaisir 🙂</p>

  </article>
</div>
<div class="keywords">
    <span class="post-tags"><a href="/archives/#user-land"><i class="fas fa-tags"></i> User Land</a><a href="/archives/#linux"><i class="fas fa-tags"></i> Linux</a></span>
  </div>


<br />
<div class="box">
  <div class="dash">
    <div class="picture">
      <img src="/assets/icones/pixis_logo.png" alt="logo" title="logo" />
    </div>
    <div class="box_content">
      <strong>Auteur</strong> : <a href="/contact/" target="_blank">Pixis</a><br />
      Créateur du blog, suivez-moi sur <a href="https://twitter.com/HackAndDo/" target="_blank">twitter</a> ou <a href="https://discord.gg/9At6SUZ" target="blank">discord</a>
    </div>
    
  </div>
</div>


<div class="related">
  <h2>Articles similaires</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/pass-the-hash/">
            Pass the Hash
            <small>18 Dec 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/remote-lsass-dump-passwords/">
            Extraction des secrets de lsass à distance
            <small>28 Nov 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/bloodhound/">
            BloodHound
            <small>30 Jul 2019</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    
    var disqus_config = function () {
        this.page.url = 'http://localhost:4000/wget-segfault-resume/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '0000-0000-0000-0007';
    };
    
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//hackndo.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        </div>
    </main>
    <script src="/assets/js/jquery-2.1.4.js"></script>
    <script src="/assets/js/jquery.menu-aim.js"></script>
    <script src="/assets/js/anchor.min.js"></script>
    <script src="/assets/js/main.js"></script> <!-- Resource jQuery -->
  </body>
</html>