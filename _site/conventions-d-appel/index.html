<!doctype html>
<html lang="fr-fr" class="no-js">

  <head>
    <link href="http://gmpg.org/xfn/11" rel="profile" hreflang="fr">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
    <meta name="google-site-verification" content="JeRPv2CEcpONAy8C7dMr1nzjlpZxlxYCtt2PnuQ78g8" />
    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  
    <title>
      
        Les conventions d'appel - hackndo
      
    </title>

	<link rel="stylesheet" href="/assets/css/style.css?v=1.13"> <!-- Resource style -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Signika:600"> <!-- Logo font -->
    <script src="/assets/js/modernizr.js"></script> <!-- Modernizr -->
    
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/icones/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/icones/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/icones/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/icones/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/icones/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/icones/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/icones/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icones/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icones/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icones/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icones/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/icones/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icones/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/res/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/icones/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
  	
	<!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hackndo" />

    <!-- Twitter card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@hackanddo" />
    <meta name="twitter:creator" content="@hackanddo" />
    <meta name="twitter:title" content="Les conventions d'appel" />
    <meta name="twitter:description" content="Voici un article qui n'est pas vraiment technique, pas vraiment compliqué, et pour lequel on trouve de la doc un peu partout, mais c'est le genre d'information que je lis un jour, que j'oublie quelques semaines plus tard, donc que j'ai envie de résumer avec mes mots une bonne fois pour toute" />
    
    <meta name="twitter:image" content="http://localhost:4000/assets/uploads/2018/05/conventions-d-appel.png" />
    
  
    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  
      ga('create', 'UA-80312745-1', 'auto');
      ga('send', 'pageview');
  
    </script>
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Les conventions d’appel" />
<meta name="author" content="Pixis" />
<meta property="og:locale" content="fr_FR" />
<meta name="description" content="Voici un article qui n’est pas vraiment technique, pas vraiment compliqué, et pour lequel on trouve de la doc un peu partout, mais c’est le genre d’information que je lis un jour, que j’oublie quelques semaines plus tard, donc que j’ai envie de résumer avec mes mots une bonne fois pour toute" />
<meta property="og:description" content="Voici un article qui n’est pas vraiment technique, pas vraiment compliqué, et pour lequel on trouve de la doc un peu partout, mais c’est le genre d’information que je lis un jour, que j’oublie quelques semaines plus tard, donc que j’ai envie de résumer avec mes mots une bonne fois pour toute" />
<link rel="canonical" href="http://localhost:4000/conventions-d-appel/" />
<meta property="og:url" content="http://localhost:4000/conventions-d-appel/" />
<meta property="og:site_name" content="hackndo" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-20T23:35:33+02:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icones/logo.png"},"name":"Pixis"},"url":"http://localhost:4000/conventions-d-appel/","headline":"Les conventions d’appel","dateModified":"2018-05-20T23:35:33+02:00","datePublished":"2018-05-20T23:35:33+02:00","author":{"@type":"Person","name":"Pixis"},"description":"Voici un article qui n’est pas vraiment technique, pas vraiment compliqué, et pour lequel on trouve de la doc un peu partout, mais c’est le genre d’information que je lis un jour, que j’oublie quelques semaines plus tard, donc que j’ai envie de résumer avec mes mots une bonne fois pour toute","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/conventions-d-appel/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <header class="cd-main-header">
    <a href="/" class="cd-logo"><img src="/assets/icones/logo.png" /> <span class="cd-logo-title">hackndo</span></a>
		
    <a href="#0" class="cd-nav-trigger">Menu<span></span></a>

</header> <!-- .cd-main-header -->
    <main class="cd-main-content">
		<nav class="cd-side-nav">
            <div class="sidebar-about">
    <h1>
        <img id="site-logo" src="/assets/icones/logo.png" alt="logo" title="logo" />
        <a class="sidebar-title" href="/">
        hackndo
        </a>
    </h1>
    <p class="lead">Think out of the box</p>
</div>

<ul>
    <li class="cd-label">Blog</li>
    <li class="">
        <a href="/">Home</a>
    </li>
    
    
        
            
        
    
        
            
                <li class="">
                    <a href="/about/">À propos</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/archives/">Archives</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/contact/">Me contacter</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/disclaimer/">Disclaimer</a>
                </li>
            
        
    
        
    
        
            
        
    
        
            
                <li class="">
                    <a href="/projects/">Projets</a>
                </li>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
    
        
    
</ul>
<ul>
    <li class="cd-label">Liens</li>
    <li><a href="https://www.dailysecurity.fr/" target="_blank">Blog de Geluchat</a></li>
    <li><a href="http://lsdsecdaemon.com" target="_blank">Blog de Th3_l5D</a></li>
    <li><a href="http://inf0sec.fr" target="_blank">Blog de Matthieu</a></li>
</ul>
<p class="sidebar-copyright">&copy; 2019. Tous droits réservés.</p>
<div class="sidebar-social">
<ul>
  <li><a href="https://twitter.com/HackAndDo" title="Twitter" target="_blank"><img alt="Twitter" title="Twitter" src="/assets/icones/social/twitter.png" /></a></li>
  <li><a href="https://github.com/hackndo" title="Github" target="_blank"><img title="Github" alt="Github" src="/assets/icones/social/github.png" /></a></li>
  <li><a href="https://www.youtube.com/channel/UC9WYWHLdu9TK-0Hu3wcHJ9g" title="Youtube" target="_blank"><img title="Youtube" alt="Youtube" src="/assets/icones/social/youtube.png" /></a></li>
  <li><a href="https://discord.gg/9At6SUZ" title="Discord" target="_blank"><img title="Discord" alt="Discord" src="/assets/icones/social/discord.png" /></a></li>
  <li><a href="https://www.linkedin.com/in/romainbentz/" title="LinkedIn" target="_blank"><img title="LinkedIn" alt="LinkedIn" src="/assets/icones/social/linkedin.png" /></a></li>
  <li><a href="https://sh.hackndo.com" title="Shell" target="_blank"><img title="Shell" alt="Shell" src="/assets/icones/social/shell.png" /></a></li>
  <li><a href="/feed.xml" title="RSS" target="_blank"><img title="RSS" alt="RSS" src="/assets/icones/social/rss.png" /></a></li>
  <li><a href="https://ko-fi.com/hackndo" title="Ko-Fi" target="_blank"><img title="Ko-Fi" alt="Ko-Fi" src="/assets/icones/social/kofi.gif" /></a></li>
</ul>
</div>
        </nav>

        <div class="content-wrapper">
            <div class="post">
  
  <div class="post-cover">
    <img src="/assets/uploads/2018/05/conventions-d-appel.png" alt="Les conventions d'appel" title="Les conventions d'appel" />
  </div>
  
  <h1 class="post-title">Les conventions d'appel</h1>
  <div class="post-info">
      <p class="alignleft">20 May 2018 <a class="post-comments-count" href="http://http://localhost:4000/conventions-d-appel/#disqus_thread"></a></p>
      <p class="alignright">Auteur : <strong><a href="https://twitter.com/HackAndDo">Pixis</a></strong></p>
      <div class="keywords">
        <span class="post-tags"><a href="/archives/#misc"><i class="fas fa-tags"></i> Misc</a></span>
      </div>
</div>

  <article>
  <p>Voici un article qui n’est pas vraiment technique, pas vraiment compliqué, et pour lequel on trouve de la doc un peu partout, mais c’est le genre d’information que je lis un jour, que j’oublie quelques semaines plus tard, donc que j’ai envie de résumer avec mes mots une bonne fois pour toute. Allons donc (re)découvrir les conventions d’appel dans le monde x86.</p>

<!--more-->

<h2 id="introduction">Introduction</h2>

<p>Lorsqu’un programme est compilé (i.e. quand le code haut niveau utilisé par le programmeur est traduit en code machine), il existe différentes conventions pour les appels de fonctions. Certaines décident que la fonction appelante prend ses responsabilités en nettoyant la pile après l’appel d’une fonction (CDECL, FASTCALL).</p>

<p>D’autres cependant responsabilisent les fonctions en leur demandant de s’occuper de leur espace mémoire, et de tout bien nettoyer quand elles ont terminé (STDCALL).</p>

<p>Il y a également différentes manières de passer des arguments à; une fonction, par la pile ou par les registres.</p>

<p>Voici alors un article qui permet de clarifier tous ces points, permettant à; chacun d’avoir une rapide synthèse des différentes conventions d’appel.</p>

<p>Il est alors nécessaire de découper cet article en deux. Une première partie historique qui énumère les principales conventions d’appel pour les architectures 32 bits, puis une deuxième qui présente la convention par défaut sur les architectures 64 bits.</p>

<h2 id="32-bits">32 bits</h2>

<p>Dans les architectures 32 bits, il y a quelques registres disponibles, et quelques conventions d’appel existantes. Voici les principales.</p>

<h3 id="cdecl-standard-c-calling-convention">CDECL (Standard C Calling Convention)</h3>

<p>Cette convention est celle utilisée par défaut par la plupart des compilateurs C/C++.</p>

<p>Ici, c’est la fonction appelante qui nettoie la pile pour la fonction qu’elle va appeler.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">caller</span><span class="o">:</span>
    <span class="k">push</span>    <span class="mi">3</span>        <span class="c">; Utilisation de 4 octets sur la pile</span>
    <span class="k">push</span>    <span class="mi">2</span>        <span class="c">; Utilisation de 4 octets sur la pile</span>
    <span class="k">push</span>    <span class="mi">1</span>        <span class="c">; Utilisation de 4 octets sur la pile</span>
    <span class="k">call</span>    <span class="n">callee</span>   <span class="c">; Appel de la fonction</span>
    <span class="k">add</span>     <span class="n">esp</span><span class="p">,</span> <span class="mh">0xc</span> <span class="c">; L'espace qui avait été alloué sur la pile pour les variables (12 octets) est nettoyé</span>
</code></pre></div></div>

<h3 id="stdcall-standard-call">STDCALL (Standard Call)</h3>

<p>Les arguments sont poussés sur la pile avant l’appel de la fonction, et la fonction appelée est responsable du nettoyage de la pile, de telle sorte que lorsque la fonction est terminée et que le programme reprend son exécution après l’appel de la fonction, la pile semble ne pas avoir été modifiée.</p>

<p>Il y a donc un prologue et un épilogue dans chaque fonction pour gérer la construction et la destruction de la pile nécessaire au bon fonctionnement de cette fonction.</p>

<p>Lorsque la fonction appelée se termine, il y aura un appel à; l’instruction return avec un argument qui lui sera passé, argument correspondant au nombre d’octets à; libérer au moment du retour à; la fonction appelante.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">caller</span><span class="o">:</span>
    <span class="k">push</span>    <span class="mi">3</span>
    <span class="k">push</span>    <span class="mi">2</span>
    <span class="k">push</span>    <span class="mi">1</span>
    <span class="k">call</span> <span class="n">callee</span>
</code></pre></div></div>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">callee</span><span class="o">:</span>
    <span class="k">push</span> <span class="n">ebp</span>
    <span class="k">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
    <span class="p">...</span>
    <span class="k">mov</span> <span class="n">esp</span><span class="p">,</span> <span class="n">ebp</span>
    <span class="k">pop</span> <span class="n">ebp</span>
    <span class="n">return</span> <span class="mh">0xc</span>       <span class="c">; Car il y a 3 argument sur 4 octets à libérer, donc 12 octets</span>
</code></pre></div></div>

<h3 id="fastcall-fast-calling-convention">FASTCALL (Fast Calling Convention)</h3>

<p>Dans cette convention d’appel, les arguments ne sont plus poussés sur la pile, mais enregistrés dans des registres. Cependant, dans une architecture 32 bits, seuls 2 registres sont utilisables pour cette convention. S’il y a plus de deux arguments à; passer à; la fonction, les suivants seront poussés sur la pile, comme dans les deux conventions d’appel vues précédemment.</p>

<p>Par ailleurs, c’est la fonction appelée qui est responsable du nettoyage de la pile.</p>

<p>Cette convention est théoriquement plus rapide à; l’exécution car elle réduit le nombre de cycles d’instructions.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">caller</span><span class="o">:</span>
    <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">3</span>
    <span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">2</span>
    <span class="k">call</span> <span class="n">callee</span>
</code></pre></div></div>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">callee</span><span class="o">:</span>
    <span class="k">push</span> <span class="n">ebp</span>
    <span class="k">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
    <span class="p">...</span>
    <span class="k">mov</span> <span class="n">esp</span><span class="p">,</span> <span class="n">ebp</span>
    <span class="k">pop</span> <span class="n">ebp</span>
    <span class="n">return</span>
</code></pre></div></div>

<h2 id="64-bits">64 bits</h2>

<p>Suite à l’arrivée de 8 nouveaux registres dans les architectures 64 bits (r8 à r15), c’est la convention FASTCALL qui est devenue celle par défaut. Elle permet alors de passer 4 arguments via les registres, au lieu de 2 comme pour les architectures 32 bits.</p>

<p>S’il y a plus de 4 arguments, les suivants sont poussés sur la pile.</p>

<p>Les registres utilisés sont, dans l’ordre, <code class="highlighter-rouge">rcx</code>, <code class="highlighter-rouge">rdx</code>, <code class="highlighter-rouge">r8</code> et <code class="highlighter-rouge">r9</code>.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">caller</span><span class="o">:</span>
    <span class="k">mov</span> <span class="n">r9</span><span class="p">,</span> <span class="mi">4</span>
    <span class="k">mov</span> <span class="n">r8</span><span class="p">,</span> <span class="mi">3</span>
    <span class="k">mov</span> <span class="n">rdx</span><span class="p">,</span> <span class="mi">2</span>
    <span class="k">mov</span> <span class="n">rcx</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">call</span> <span class="n">callee</span>
</code></pre></div></div>

<h2 id="récapitulatif">Récapitulatif</h2>

<p>Voici les deux tableaux récapitulatifs qui permettent d’avoir une vision rapide des différentes conventions d’appel abordées dans cet article</p>

<h3 id="32-bits-1">32 bits</h3>

<table>
  <thead>
    <tr>
      <th>Convention</th>
      <th style="text-align: center">Transmission des arguments</th>
      <th style="text-align: center">Responsabilité maintenance pile</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CDECL</td>
      <td style="text-align: center">Poussés sur la pile</td>
      <td style="text-align: center">Fonction appelante</td>
    </tr>
    <tr>
      <td>STDCALL</td>
      <td style="text-align: center">Poussés sur la pile</td>
      <td style="text-align: center">Fonction appelée</td>
    </tr>
    <tr>
      <td>FASTCALL</td>
      <td style="text-align: center">2 registres puis sur la pile</td>
      <td style="text-align: center">Fonction appelée</td>
    </tr>
  </tbody>
</table>

<h3 id="64-bits-1">64 bits</h3>

<table>
  <thead>
    <tr>
      <th>Convention</th>
      <th style="text-align: center">Transmission des arguments</th>
      <th style="text-align: center">Responsabilité maintenance pile</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>FASTCALL</td>
      <td style="text-align: center">4 registres puis sur la pile</td>
      <td style="text-align: center">Fonction appelée</td>
    </tr>
  </tbody>
</table>

<p>J’espère que cet article sur les conventions d’appel remettant les choses au clair, en restant concis et en allant à l’essentiel, vous permettra de vite trouver les informations que vous cherchez sur ce sujet.</p>

  </article>
</div>
<div class="keywords">
    <span class="post-tags"><a href="/archives/#misc"><i class="fas fa-tags"></i> Misc</a></span>
  </div>


<br />
<div class="box">
  <div class="dash">
    <div class="picture">
      <img src="/assets/icones/pixis_logo.png" alt="logo" title="logo" />
    </div>
    <div class="box_content">
      <strong>Auteur</strong> : <a href="/contact/" target="_blank">Pixis</a><br />
      Créateur du blog, suivez-moi sur <a href="https://twitter.com/HackAndDo/" target="_blank">twitter</a> ou <a href="https://discord.gg/9At6SUZ" target="blank">discord</a>
    </div>
    
  </div>
</div>


<div class="related">
  <h2>Articles similaires</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/pass-the-hash/">
            Pass the Hash
            <small>18 Dec 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/remote-lsass-dump-passwords/">
            Extraction des secrets de lsass à distance
            <small>28 Nov 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/bloodhound/">
            BloodHound
            <small>30 Jul 2019</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    
    var disqus_config = function () {
        this.page.url = 'http://localhost:4000/conventions-d-appel/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '0000-0000-0000-00a1';
    };
    
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//hackndo.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        </div>
    </main>
    <script src="/assets/js/jquery-2.1.4.js"></script>
    <script src="/assets/js/jquery.menu-aim.js"></script>
    <script src="/assets/js/anchor.min.js"></script>
    <script src="/assets/js/main.js"></script> <!-- Resource jQuery -->
  </body>
</html>