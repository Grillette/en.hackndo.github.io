<!doctype html>
<html lang="fr-fr" class="no-js">

  <head>
    <link href="http://gmpg.org/xfn/11" rel="profile" hreflang="fr">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
    <meta name="google-site-verification" content="JeRPv2CEcpONAy8C7dMr1nzjlpZxlxYCtt2PnuQ78g8" />
    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  
    <title>
      
        Délégation Kerberos - Fonctionnement - hackndo
      
    </title>

	<link rel="stylesheet" href="/assets/css/style.css?v=1.13"> <!-- Resource style -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Signika:600"> <!-- Logo font -->
    <script src="/assets/js/modernizr.js"></script> <!-- Modernizr -->
    
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/icones/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/icones/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/icones/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/icones/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/icones/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/icones/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/icones/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icones/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icones/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icones/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icones/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/icones/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icones/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/res/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/icones/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
  	
	<!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hackndo" />

    <!-- Twitter card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@hackanddo" />
    <meta name="twitter:creator" content="@hackanddo" />
    <meta name="twitter:title" content="Délégation Kerberos - Fonctionnement" />
    <meta name="twitter:description" content="Au sein d'un Active Directory, des services peuvent être utilisés par des utilisateurs. Il arrive parfois que ces services doivent en contacter d'autres, au nom de l'utilisateur, comme un service web pourrait avoir besoin de contacter un serveur de fichiers. Afin d'autoriser un service à accéder à un autre service au nom de l'utilisateur, une solution a été mise en place : La délégation Kerberos." />
    
    <meta name="twitter:image" content="http://localhost:4000/assets/uploads/2019/02/impersonation.png" />
    
  
    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  
      ga('create', 'UA-80312745-1', 'auto');
      ga('send', 'pageview');
  
    </script>
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Délégation Kerberos - Fonctionnement" />
<meta name="author" content="Pixis" />
<meta property="og:locale" content="fr_FR" />
<meta name="description" content="Au sein d’un Active Directory, des services peuvent être utilisés par des utilisateurs. Il arrive parfois que ces services doivent en contacter d’autres, au nom de l’utilisateur, comme un service web pourrait avoir besoin de contacter un serveur de fichiers. Afin d’autoriser un service à accéder à un autre service au nom de l’utilisateur, une solution a été mise en place : La délégation Kerberos." />
<meta property="og:description" content="Au sein d’un Active Directory, des services peuvent être utilisés par des utilisateurs. Il arrive parfois que ces services doivent en contacter d’autres, au nom de l’utilisateur, comme un service web pourrait avoir besoin de contacter un serveur de fichiers. Afin d’autoriser un service à accéder à un autre service au nom de l’utilisateur, une solution a été mise en place : La délégation Kerberos." />
<link rel="canonical" href="http://localhost:4000/constrained-unconstrained-delegation/" />
<meta property="og:url" content="http://localhost:4000/constrained-unconstrained-delegation/" />
<meta property="og:site_name" content="hackndo" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-03-29T13:17:22+01:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icones/logo.png"},"name":"Pixis"},"url":"http://localhost:4000/constrained-unconstrained-delegation/","headline":"Délégation Kerberos - Fonctionnement","dateModified":"2019-03-29T13:17:22+01:00","datePublished":"2019-03-29T13:17:22+01:00","author":{"@type":"Person","name":"Pixis"},"description":"Au sein d’un Active Directory, des services peuvent être utilisés par des utilisateurs. Il arrive parfois que ces services doivent en contacter d’autres, au nom de l’utilisateur, comme un service web pourrait avoir besoin de contacter un serveur de fichiers. Afin d’autoriser un service à accéder à un autre service au nom de l’utilisateur, une solution a été mise en place : La délégation Kerberos.","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/constrained-unconstrained-delegation/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <header class="cd-main-header">
    <a href="/" class="cd-logo"><img src="/assets/icones/logo.png" /> <span class="cd-logo-title">hackndo</span></a>
		
    <a href="#0" class="cd-nav-trigger">Menu<span></span></a>

</header> <!-- .cd-main-header -->
    <main class="cd-main-content">
		<nav class="cd-side-nav">
            <div class="sidebar-about">
    <h1>
        <img id="site-logo" src="/assets/icones/logo.png" alt="logo" title="logo" />
        <a class="sidebar-title" href="/">
        hackndo
        </a>
    </h1>
    <p class="lead">Think out of the box</p>
</div>

<ul>
    <li class="cd-label">Blog</li>
    <li class="">
        <a href="/">Home</a>
    </li>
    
    
        
            
        
    
        
            
                <li class="">
                    <a href="/about/">À propos</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/archives/">Archives</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/contact/">Me contacter</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/disclaimer/">Disclaimer</a>
                </li>
            
        
    
        
    
        
            
        
    
        
            
                <li class="">
                    <a href="/projects/">Projets</a>
                </li>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
    
        
    
</ul>
<ul>
    <li class="cd-label">Liens</li>
    <li><a href="https://www.dailysecurity.fr/" target="_blank">Blog de Geluchat</a></li>
    <li><a href="http://lsdsecdaemon.com" target="_blank">Blog de Th3_l5D</a></li>
    <li><a href="http://inf0sec.fr" target="_blank">Blog de Matthieu</a></li>
</ul>
<p class="sidebar-copyright">&copy; 2019. Tous droits réservés.</p>
<div class="sidebar-social">
<ul>
  <li><a href="https://twitter.com/HackAndDo" title="Twitter" target="_blank"><img alt="Twitter" title="Twitter" src="/assets/icones/social/twitter.png" /></a></li>
  <li><a href="https://github.com/hackndo" title="Github" target="_blank"><img title="Github" alt="Github" src="/assets/icones/social/github.png" /></a></li>
  <li><a href="https://www.youtube.com/channel/UC9WYWHLdu9TK-0Hu3wcHJ9g" title="Youtube" target="_blank"><img title="Youtube" alt="Youtube" src="/assets/icones/social/youtube.png" /></a></li>
  <li><a href="https://discord.gg/9At6SUZ" title="Discord" target="_blank"><img title="Discord" alt="Discord" src="/assets/icones/social/discord.png" /></a></li>
  <li><a href="https://www.linkedin.com/in/romainbentz/" title="LinkedIn" target="_blank"><img title="LinkedIn" alt="LinkedIn" src="/assets/icones/social/linkedin.png" /></a></li>
  <li><a href="https://sh.hackndo.com" title="Shell" target="_blank"><img title="Shell" alt="Shell" src="/assets/icones/social/shell.png" /></a></li>
  <li><a href="/feed.xml" title="RSS" target="_blank"><img title="RSS" alt="RSS" src="/assets/icones/social/rss.png" /></a></li>
  <li><a href="https://ko-fi.com/hackndo" title="Ko-Fi" target="_blank"><img title="Ko-Fi" alt="Ko-Fi" src="/assets/icones/social/kofi.gif" /></a></li>
</ul>
</div>
        </nav>

        <div class="content-wrapper">
            <div class="post">
  
  <div class="post-cover">
    <img src="/assets/uploads/2019/02/impersonation.png" alt="Délégation Kerberos - Fonctionnement" title="Délégation Kerberos - Fonctionnement" />
  </div>
  
  <h1 class="post-title">Délégation Kerberos - Fonctionnement</h1>
  <div class="post-info">
      <p class="alignleft">29 Mar 2019 <a class="post-comments-count" href="http://http://localhost:4000/constrained-unconstrained-delegation/#disqus_thread"></a></p>
      <p class="alignright">Auteur : <strong><a href="https://twitter.com/HackAndDo">Pixis</a></strong></p>
      <div class="keywords">
        <span class="post-tags"><a href="/archives/#active-directory"><i class="fas fa-tags"></i> Active Directory</a><a href="/archives/#windows"><i class="fas fa-tags"></i> Windows</a></span>
      </div>
</div>

  <article>
  <p>Au sein d’un Active Directory, des services peuvent être utilisés par des utilisateurs. Il arrive parfois que ces services doivent en contacter d’autres, au nom de l’utilisateur, comme un service web pourrait avoir besoin de contacter un serveur de fichiers. Afin d’autoriser un service à accéder à un autre service <strong>au nom de l’utilisateur</strong>, une solution a été mise en place (introduite à partir de Windows Server 2000) pour répondre à ce besoin : <strong>La délégation Kerberos.</strong></p>

<!--more-->

<h2 id="principe-de-la-délégation">Principe de la délégation</h2>

<p>Pour comprendre le principe de la délégation Kerberos, prenons un exemple concret. Une machine héberge un service Web qui, via une jolie interface, permet à un utilisateur d’accéder à son dossier personnel, hébergé sur un serveur de fichiers. Nous sommes donc dans la situation suivante :</p>

<p><a href="/assets/uploads/2019/02/webfsuser.png"><img src="/assets/uploads/2019/02/webfsuser.png" alt="Etat actuel" /></a></p>

<p>Le serveur Web est en frontal, et c’est lui qui va chercher les informations à la place de l’utilisateur sur le serveur de fichiers afin d’afficher le contenu d’un dossier, par exemple.</p>

<p>Cependant, le serveur web ne sait pas ce qui appartient à l’utilisateur sur le serveur de fichiers. Ce n’est pas son rôle à lui de décortiquer le <a href="/kerberos-silver-golden-tickets/#pac">PAC</a> de l’utilisateur pour faire une demande spécifique au serveur de fichiers. C’est là qu’entre en jeu la <strong>délégation</strong>. Ce mécanisme permet au serveur web de prendre la place de l’utilisateur, et de s’authentifier au nom de celui-ci auprès du serveur de fichiers. Ainsi, du point de vue du serveur de fichiers, c’est l’utilisateur qui fait la demande, et le serveur de fichiers va pouvoir vérifier les droits de cet utilisateur, puis renvoyer les informations auxquelles ce compte a accès. C’est de cette manière que le serveur web peut ensuite afficher ces informations dans une jolie interface.</p>

<p><a href="/assets/uploads/2019/02/impersonation.png"><img src="/assets/uploads/2019/02/impersonation.png" alt="Impersonation" /></a></p>

<h2 id="constrained--unconstrained-delegation">Constrained &amp; Unconstrained Delegation</h2>

<p>La possibilité de relayer des identifiants peut être donnée à une machine ou un utilisateur de service, c’est à dire qui possède au moins un attibut <a href="/service-principal-name-spn">SPN</a>.</p>

<p>Il existe aujourd’hui trois manières d’autoriser une machine ou un compte de service de prendre la place d’un utilisateur pour communiquer avec un ou plusieurs autre(s) service(s) : La <strong>Unconstrained Delegation</strong>, la <strong>Constrained Delegation</strong> et la <strong>Resource Based Constrained Delegation</strong>.</p>

<h3 id="kerberos-unconstrained-delegation---kud">Kerberos Unconstrained Delegation - KUD</h3>

<p>Dans le cas d’une <strong>Unconstrained Delegation</strong> (KUD), le serveur ou le compte de service qui se voit attribuer ce droit est en mesure de se faire passer pour l’utilisateur pour communiquer avec <strong>n’importe quel service</strong> sur <strong>n’importe quelle machine</strong>.</p>

<p>C’est historiquement le seul choix qu’il y avait lors de l’instauration du principe de délégation, mais il a été complété par le principe de la <strong>Constrained Delegation</strong>.</p>

<p><a href="/assets/uploads/2019/02/unconstrained_delegation_schema.png"><img src="/assets/uploads/2019/02/unconstrained_delegation_schema.png" alt="Unconstrained Delegation" /></a></p>

<p>Voici un exemple, dans mon lab, d’une machine qui est en <strong>Unconstrained Delegation</strong> :</p>

<p><a href="/assets/uploads/2019/02/unconstrained_delegation.png"><img src="/assets/uploads/2019/02/unconstrained_delegation.png" alt="Unconstrained Delegation" /></a></p>

<h3 id="kerberos-constrained-delegation---kcd">Kerberos Constrained Delegation - KCD</h3>

<p>Si une machine ou un compte de service possède le flag <strong>Constrained Delegation</strong> (KCD), alors une liste de services autorisés sera associée à ce droit. Par exemple, dans le cas du serveur web de l’introduction, la machine hébergeant le serveur web aura le drapeau <strong>KCD</strong> avec comme précision que ce serveur ne peut relayer les informations de l’utilisateur qu’au service <code class="highlighter-rouge">CIFS</code> du serveur <code class="highlighter-rouge">SERVEUR01</code>.</p>

<p><a href="/assets/uploads/2019/02/constrained_delegation_schema.png"><img src="/assets/uploads/2019/02/constrained_delegation_schema.png" alt="Constrained Delegation" /></a></p>

<p>C’est donc le serveur relayant les informations de l’utilisateur qui possède l’information des services (<a href="/service-principal-name-spn">SPN</a>) autorisés.</p>

<p>En d’autres termes, le serveur en frontal va dire “je suis autorisé à m’authentifier en tant que l’utilisateur auprès de cette liste de <a href="/service-principal-name-spn">SPN</a> : […]”.</p>

<p>Dans mon lab, le serveur web est <code class="highlighter-rouge">WEB-SERVER-01</code> et celui qui possède le partage de fichiers est <code class="highlighter-rouge">WEB-SERVER-02</code>. Voici donc à quoi ressemble la liste des services pour lesquels <code class="highlighter-rouge">WEB-SERVER-01</code> peut se faire passer pour l’utilisateur :</p>

<p><a href="/assets/uploads/2019/02/delegation_cifs.png"><img src="/assets/uploads/2019/02/delegation_cifs.png" alt="Delegation CIFS" /></a></p>

<p><strong>&lt;note&gt;</strong></p>

<p>De ma compréhension, le statut délégation ne peut être appliqué qu’à une machine ou un utilisateur de service (i.e. ayant au moins un attribut <a href="/service-principal-name-spn">SPN</a>).</p>
<ul>
  <li>Dans le premier cas (Machine), cela implique que <strong>tous</strong> les services hébergés sur la machine peuvent relayer les informations de l’utilisateur.</li>
  <li>Dans le deuxième cas (compte de service), cela veut dire que quel que soit le serveur sur lequel tournent les services exécutés par ce compte de service, ils – ces services – auront tous la possibilité de délégation.</li>
</ul>

<p>Je trouve ce comportement étonnant, j’aurais pensé qu’il était possible de décider que seul un service précis sur une machine précise pouvait relayer les informations de l’utilisateur, mais il me semble, en l’état, que cette granularité n’existe pas.</p>

<p>Si ma compréhension est incorrecte, n’hésitez pas à me le remonter dans les commentaires ou sur <a href="https://twitter.com/HackAndDo">twitter</a>.</p>

<p><strong>&lt;/note&gt;</strong></p>

<h3 id="resource-based-kerberos-constrained-delegation---rbkcd">Resource Based Kerberos Constrained Delegation - RBKCD</h3>

<p>Enfin, nous avons le cas de la <strong>Resource Based Constrained Delegation</strong> (RBKCD). Apparue avec Windows Server 2012, cette solution permet de palier à quelques problèmes liés à la <strong>KCD</strong> (Responsabilité, délégation inter-domaines, …). Sans trop aller dans les détails, la responsabilité de la délégation est déplacée. Alors que dans <strong>KCD</strong>, c’est au niveau du serveur qui délègue qu’on indique les <a href="/service-principal-name-spn">SPN</a> autorisés, dans le cas du <strong>RBKCD</strong>, c’est au niveau des services finaux qu’on indique la liste des services qui peuvent communiquer avec eux via délégation. Ainsi, le schéma est le suivant :</p>

<p><a href="/assets/uploads/2019/02/resource_based_constrained_delegation_schema.png"><img src="/assets/uploads/2019/02/resource_based_constrained_delegation_schema.png" alt="Resource Based Constrained Delegation" /></a></p>

<p>La responsabilité est déplacée, c’est au niveau du serveur qui reçoit les connexions avec délégation que se trouve l’information de si oui ou non cette délégation est acceptée.</p>

<p>En d’autres termes, c’est le service final qui dit “j’autorise cette liste de compte […] à s’authentifier chez moi au nom d’un utilisateur”.</p>

<h2 id="détails-techniques">Détails techniques</h2>

<p>Maintenant que le principe est compris (du moins je l’espère), nous allons détailler un peu ce process. Concrètement, comment est-ce qu’une machine ou un compte peut se faire passer pour un utilisateur auprès d’un service ? C’est ce que nous allons voir maintenant. Les détails entre les différentes techniques sont relativement différents, c’est pourquoi chacune d’entre elle sera expliquée séparemment. Accrochez vous, <em>it’s gonna get dirty</em>.</p>

<h3 id="kerberos-unconstrained-delegation---kud-1">Kerberos Unconstrained Delegation - KUD</h3>

<p>Comme nous l’avons vu, dans ce cas, le serveur ou le compte de service peut s’authentifier au nom de l’utilisateur auprès de n’importe quel autre service. Pour que cela soit possible, il faut deux prérequis :</p>

<ul>
  <li>Le premier est que le compte qui veut déléguer une authentification possède le drapeau <code class="highlighter-rouge">ADS_UF_TRUSTED_FOR_DELEGATION</code> présent dans <a href="https://docs.microsoft.com/en-us/windows/desktop/api/iads/ne-iads-ads_user_flag">ADS_USER_FLAG_ENUM</a>. Pour pouvoir changer cette information, il faut avoir le droit <code class="highlighter-rouge">SeEnableDelegationPrivilege</code> qui est la plupart du temps seulement existant pour les administrateurs de domaine. Voici comment ce drapeau est placé sur le compte (machine ou compte de service):</li>
</ul>

<p><a href="/assets/uploads/2019/02/unconstrained_delegation.png"><img src="/assets/uploads/2019/02/unconstrained_delegation.png" alt="Unconstrained Delegation" /></a></p>

<ul>
  <li>Le deuxième est que le compte utilisateur qui va être relayé soit effectivement “relayable”. Pour cela, il <strong>ne faut pas</strong> faut que le drapeau <a href="https://docs.microsoft.com/en-us/windows/desktop/api/iads/ne-iads-ads_user_flag">ADS_UF_NOT_DELEGATED</a> soit positionné. Par défaut, aucun compte de l’AD n’a ce drapeau de positionné, ils sont donc tous “relayables”.</li>
</ul>

<p>Concrètement, lors des échanges avec le contrôleur de domaine tels que décrits dans l’article <a href="/kerberos">Kerberos en Active Directory</a>, lorsque l’utilisateur fait une demande de TGS (<a href="/kerberos/#krb_tgs_req">KRB_TGS_REQ</a>), il précisera le <a href="/service-principal-name-spn">SPN</a> du service qu’il souhaite consommer. C’est à ce moment que le contrôleur de domaine va chercher les deux prérequis :</p>

<ul>
  <li>Est-ce que le drapeau <code class="highlighter-rouge">ADS_UF_TRUSTED_FOR_DELEGATION</code> est positionné dans les attributs du compte associé au <a href="/service-principal-name-spn">SPN</a></li>
  <li>Est-ce que le drapeau <code class="highlighter-rouge">ADS_UF_NOT_DELEGATED</code> n’est <strong>pas</strong> positionné pour l’utilisateur qui fait la demande</li>
</ul>

<p>Si les deux prérequis sont vérifiés, alors le contrôleur de domaine va répondre à l’utilisateur avec un <a href="/kerberos/#krb_tgs_req">KRB_TGS_REQ</a> contenant les informations classiques, mais il va également intégrer dans sa réponse <strong>une copie du TGT</strong> de l’utilisateur, ainsi qu’une nouvelle clé de session associée.</p>

<p><a href="/assets/uploads/2019/02/cop_tgt.png"><img src="/assets/uploads/2019/02/cop_tgt.png" alt="TGT Copy" /></a></p>

<p>Une fois en possession de ces éléments, l’utilisateur va continuer le processus classique en envoyant une requête auprès du service (<a href="/kerberos/#krb_ap_req">KRB_AP_REQ</a>) en lui envoyant le TGS et un authentifiant. Le service va être en mesure de déchiffrer le contenu du TGS, vérifier l’identité de l’utilisateur en déchiffrant l’authentifiant, mais surtout il va pouvoir récupérer la copie du TGT ainsi que la clé de session associée pour, ensuite, se faire passer pour l’utilisateur auprès du contrôleur de domaine.</p>

<p><a href="/assets/uploads/2019/02/tgt_memory.png"><img src="/assets/uploads/2019/02/tgt_memory.png" alt="TGT Memory" /></a></p>

<p>En effet, maintenant en possession d’une copie du TGT de l’utilisateur ainsi que d’une clé de session valide, le service peut s’authentifier auprès de n’importe quel autre service au nom de l’utilisateur en faisant une demande de TGS au contrôleur de domaine, en lui fournissant ce TGT et en chiffrant un authentifiant avec la clé de session. C’est le principe de la <strong>Unconstrained Delegation</strong>.</p>

<p>Voici un schéma récapitulatif :</p>

<p><a href="/assets/uploads/2019/02/unconstrained_delegation_detailed.png"><img src="/assets/uploads/2019/02/unconstrained_delegation_detailed.png" alt="Unconstrained Delegation Detailed" /></a></p>

<h3 id="kerberos-constrained-delegation">Kerberos Constrained Delegation</h3>

<p>Pour la <strong>Constrained Delegation</strong>, une liste de <a href="/service-principal-name-spn">SPN</a> ou de comptes autorisés sera fournie pour indiquer les services/comptes acceptés pour la délégation. De ce fait, le processus n’est pas le même. Le service concerné ne sera pas en possession du TGT de l’utilisateur, sinon il n’y a aucun moyen de contrôler les authentifications du service. Un mécanisme différent est utilisé.</p>

<p>Mettons nous dans le cas où l’utilisateur s’authentifie auprès du <code class="highlighter-rouge">Service A</code> puis que ce <code class="highlighter-rouge">Service A</code> doit s’authentifier auprès du <code class="highlighter-rouge">Service B</code> en tant que l’utilisateur.</p>

<p>L’utilisateur fait une requête de TGS, puis l’envoie au <code class="highlighter-rouge">Service A</code>. Ce service devant s’authentifier en tant que l’utilisateur auprès de <code class="highlighter-rouge">Service B</code>, il va demander un TGS au KDC au nom de l’utilisateur. Cette demande est régie par l’extension <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/bde93b0e-f3c9-4ddf-9f44-e1453be7af5a">S4U2Proxy</a>. Pour indiquer au contrôleur de domaine qu’il veut s’authentifier au nom de quelqu’un d’autre, deux attributs seront définis dans la demande de ticket <a href="/kerberos/#krb_tgs_req">KRB_TGS_REQ</a> :</p>

<ul>
  <li>le champ <code class="highlighter-rouge">additional-tickets</code>, d’habitude vide, doit cette fois contenir le TGS de l’utilisateur en question (sous condition que le drapeau <code class="highlighter-rouge">ADS_UF_NOT_DELEGATED</code> ne soit <strong>pas</strong> positionné pour l’utilisateur qui fait la demande. Si c’était le cas, le TGS de l’utilisateur ne serait pas <code class="highlighter-rouge">forwardable</code>, et le contrôleur de domaine ne l’accepterait pas dans la suite du processus)</li>
  <li>Le drapeau <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/17b9af82-d45a-437d-a05c-79547fe969f5">cname-in-addl-tkt</a>, qui doit être positionné pour indiquer au DC qu’il ne doit pas utiliser les informations du serveur, mais celle du ticket présent dans <code class="highlighter-rouge">additional-tickets</code>, c’est à dire les informations de l’utilisateur pour lequel le service veut se faire passer.</li>
</ul>

<p>C’est lors de cette demande que le contrôleur de domaine, en voyant ces informations, va vérifier que <code class="highlighter-rouge">Service A</code> a le droit de s’authentifier auprès de <code class="highlighter-rouge">Service B</code> au nom de l’utilisateur.</p>

<h4 id="constrained-delegation---classique">Constrained Delegation - Classique</h4>

<p>Dans le cas classique de <strong>Constrained Delegation</strong> (donc quand l’information est située au niveau de <code class="highlighter-rouge">Service A</code>), cette information est présente dans l’attribut <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-ada2/86261ca1-154c-41fb-8e5f-c6446e77daaa">msDS-AllowedToDelegateTo</a> <strong>de l’objet (compte) demandeur</strong>, donc de <code class="highlighter-rouge">Service A</code>, attribut qui spécifie la liste des <a href="/service-principal-name-spn">SPN</a> autorisés pour la délégation. Par exemple ici l’attribut <code class="highlighter-rouge">msDS-AllowedToDelegateTo</code> contiendra <code class="highlighter-rouge">cifs/WEB-SERVER-02</code>.</p>

<p><a href="/assets/uploads/2019/02/delegation_cifs.png"><img src="/assets/uploads/2019/02/delegation_cifs.png" alt="Delegation CIFS" /></a></p>

<p>Si le <a href="/service-principal-name-spn">SPN</a> cible est bien présent, alors le KDC renvoie un TGS valide, avec le nom de l’utilisateur, pour le service demandé. Voici un schéma récapitulatif :</p>

<p><a href="/assets/uploads/2019/02/constrained_delegation_schema_detailed.png"><img src="/assets/uploads/2019/02/constrained_delegation_schema_detailed.png" alt="Constrained Delegation Detailed" /></a></p>

<h4 id="constrained-delegation---resource-based">Constrained Delegation - Resource Based</h4>

<p>Le KDC va cette fois aller voir les attributs de <strong>Service B</strong> (et non plus de <code class="highlighter-rouge">Service A</code>). Il va vérifier que le compte associé à <code class="highlighter-rouge">Service A</code> est bien présent dans l’attribut <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-ada2/cea4ac11-a4b2-4f2d-84cc-aebb4a4ad405">msDS-AllowedToActOnBehalfOfOtherIdentity</a> du compte lié à <code class="highlighter-rouge">Service B</code>.</p>

<p><a href="/assets/uploads/2019/02/resource_based_constrained_delegation_schema_detailed.png"><img src="/assets/uploads/2019/02/resource_based_constrained_delegation_schema_detailed.png" alt="Resource Based Constrained Delegation Detailed" /></a></p>

<p>Comme le montre le schéma, le fonctionnement technique est similaire, cependant les responsabilités de chaques entités sont radicalement différentes.</p>

<h3 id="extension-s4u2self">Extension S4U2Self</h3>

<p>Si vous êtes encore là et que vous avez bien suivi, vous aurez remarqué que nous n’avons pas abordé dans cet article la notion de transition de protocole. En effet, dans ce qui a été expliqué concernant la délégation contrainte, nous partions du principe que le <code class="highlighter-rouge">Service A</code> était en possession d’un ticket de service provenant de <code class="highlighter-rouge">USER</code>, ticket qui était ajouté dans le champ <code class="highlighter-rouge">additional-tickets</code> de la demande de TGS (<strong>S4U2Proxy</strong>). Mais il arrive que l’utilisateur s’authentifie auprès du serveur d’une autre manière que via le protocole Kerberos (par exemple via NTLM, ou même un formulaire web). Dans ce cas, le serveur n’est pas en possession d’un TGS envoyé par l’utilisateur. Ainsi, <code class="highlighter-rouge">Service A</code> ne peut pas, en l’état, remplir le champ <code class="highlighter-rouge">additional-tickets</code> comme il le faisait dans les cas précédemment décrits.</p>

<p>C’est pourquoi il y a une étape supplémentaire, possible grâce à l’extension <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/02636893-7a1f-4357-af9a-b672e3e3de13">S4U2Self</a>, que <code class="highlighter-rouge">Service A</code> doit effectuer. Cette étape lui permet d’obtenir un TGS pour un utilisateur <strong>choisi arbitrairement</strong>. Pour cela, il effectue une demande de TGS classique (<a href="/kerberos/#krb_tgs_req">KRB_TGS_REQ</a>) sauf qu’au lieu de mettre son nom à lui dans le bloc <code class="highlighter-rouge">PA-FOR-USER</code> (présent dans la partie préauthentification), il met le nom d’un utilisateur <strong>qu’il choisit</strong>.</p>

<p>Evidemment, on pourrait croire que c’est une capacité très puissante et dangereuse puisqu’en fait, pour tous services <code class="highlighter-rouge">S</code> et <code class="highlighter-rouge">T</code> pour lesquels il y aurait une délégation possible de <code class="highlighter-rouge">S</code> vers <code class="highlighter-rouge">T</code>, le <code class="highlighter-rouge">Service S</code> pourrait se faire passer pour n’importe quel utilisateur auprès de <code class="highlighter-rouge">Service T</code>. Heureusement, ce n’est pas le cas. En effet, si le drapeau <a href="https://docs.microsoft.com/en-us/windows/desktop/api/iads/ne-iads-ads_user_flag">ADS_UF_TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION</a> n’est pas positionné sur l’objet associé au <code class="highlighter-rouge">Service S</code>, alors le ticket qu’il récupèrera ne sera pas tranférable (<em>forwardable</em>) et ne pourra donc pas être utilisé pour une délégation contrainte classique. Il existe un cas particulier pour la délégation Resource-Based, dont nous parlerons dans un autre article.</p>

<p>Pour que le compte puisse avoir ce drapeau, il faut le préciser ici dans l’interface graphique :</p>

<p><a href="/assets/uploads/2019/02/s4u2self_gui.png"><img src="/assets/uploads/2019/02/s4u2self_gui.png" alt="Drapeau S4U2Self" /></a></p>

<p>Attention, le schéma récapitulatif se complique, mais j’espère qu’il reste relativement clair.</p>

<p><a href="/assets/uploads/2019/02/s4u2self.png"><img src="/assets/uploads/2019/02/s4u2self.png" alt="S4U2Self" /></a></p>

<p>D’expérience, il est rare de trouver des comptes au sein d’un domaine qui possèdent ce drapeau. Si cependant un compte de ce type est compromis, alors tous les services auxquels ce compte est en droit de s’authentifier via délégation seront également compromis, puisque l’attaquant peut créer des tickets de service au nom d’utilisateurs arbitraires, notamment des utilisateurs administrateurs des services ciblés.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Je pensais faire un article qui allait décrire le principe de Constrained et Unconstrained Delegation ainsi que les attaques associées, cependant les explications sont beaucoup plus denses que prévues, ainsi cet article reste consacré à l’explication. Les attaques associées seront présentées dans d’autres articles, que je citerai ici, au fil de leurs sorties.</p>

<ul>
  <li><a href="/unconstrained-delegation-attack">Unconstrained Delegation - Risques</a></li>
</ul>

<p>Si vous avez des questions ou remarques, n’hésitez pas, je suis tout ouïe.</p>

<h2 id="ressources">Ressources</h2>

<p>Grands mercis à eux pour leurs explications claires.</p>

<ul>
  <li><a href="https://www.harmj0y.net/blog/activedirectory/s4u2pwnage/">S4U2Pwnage - Harmj0y</a></li>
  <li><a href="http://adsecurity.org/">ADSecurity - Pyrotek3</a></li>
  <li><a href="https://www.sstic.org/media/SSTIC2014/SSTIC-actes/secrets_dauthentification_pisode_ii__kerberos_cont/SSTIC2014-Article-secrets_dauthentification_pisode_ii__kerberos_contre-attaque-bordes_2.pdf">Secrets d’authentification épisode II Kerberos contre-attaque - Aurélien Bordes</a></li>
  <li><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">Wagging the dog - Edla Shamir</a></li>
</ul>

  </article>
</div>
<div class="keywords">
    <span class="post-tags"><a href="/archives/#active-directory"><i class="fas fa-tags"></i> Active Directory</a><a href="/archives/#windows"><i class="fas fa-tags"></i> Windows</a></span>
  </div>


<br />
<div class="box">
  <div class="dash">
    <div class="picture">
      <img src="/assets/icones/pixis_logo.png" alt="logo" title="logo" />
    </div>
    <div class="box_content">
      <strong>Auteur</strong> : <a href="/contact/" target="_blank">Pixis</a><br />
      Créateur du blog, suivez-moi sur <a href="https://twitter.com/HackAndDo/" target="_blank">twitter</a> ou <a href="https://discord.gg/9At6SUZ" target="blank">discord</a>
    </div>
    
  </div>
</div>


<div class="related">
  <h2>Articles similaires</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/pass-the-hash/">
            Pass the Hash
            <small>18 Dec 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/remote-lsass-dump-passwords/">
            Extraction des secrets de lsass à distance
            <small>28 Nov 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/bloodhound/">
            BloodHound
            <small>30 Jul 2019</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    
    var disqus_config = function () {
        this.page.url = 'http://localhost:4000/constrained-unconstrained-delegation/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '0000-0000-0000-00ab';
    };
    
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//hackndo.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        </div>
    </main>
    <script src="/assets/js/jquery-2.1.4.js"></script>
    <script src="/assets/js/jquery.menu-aim.js"></script>
    <script src="/assets/js/anchor.min.js"></script>
    <script src="/assets/js/main.js"></script> <!-- Resource jQuery -->
  </body>
</html>