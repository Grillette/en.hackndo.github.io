<!doctype html>
<html lang="fr-fr" class="no-js">

  <head>
    <link href="http://gmpg.org/xfn/11" rel="profile" hreflang="fr">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
    <meta name="google-site-verification" content="JeRPv2CEcpONAy8C7dMr1nzjlpZxlxYCtt2PnuQ78g8" />
    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  
    <title>
      
        Unconstrained Delegation - Risques - hackndo
      
    </title>

	<link rel="stylesheet" href="/assets/css/style.css?v=1.13"> <!-- Resource style -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Signika:600"> <!-- Logo font -->
    <script src="/assets/js/modernizr.js"></script> <!-- Modernizr -->
    
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/icones/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/icones/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/icones/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/icones/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/icones/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/icones/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/icones/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icones/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icones/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icones/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icones/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/icones/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icones/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/res/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/icones/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
  	
	<!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hackndo" />

    <!-- Twitter card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@hackanddo" />
    <meta name="twitter:creator" content="@hackanddo" />
    <meta name="twitter:title" content="Unconstrained Delegation - Risques" />
    <meta name="twitter:description" content="Cet article montre comment abuser de la délégation complète (Unconstrained Delegation) afin de récupérer le TGT d'un utilisateur, permettant ainsi de s'authentifier auprès de n'importe quel service en son nom." />
    
    <meta name="twitter:image" content="http://localhost:4000/assets/uploads/2019/04/unconstrained_admin.png" />
    
  
    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  
      ga('create', 'UA-80312745-1', 'auto');
      ga('send', 'pageview');
  
    </script>
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Unconstrained Delegation - Risques" />
<meta name="author" content="Pixis" />
<meta property="og:locale" content="fr_FR" />
<meta name="description" content="Cet article montre comment abuser de la délégation complète (Unconstrained Delegation) afin de récupérer le TGT d’un utilisateur, permettant ainsi de s’authentifier auprès de n’importe quel service en son nom." />
<meta property="og:description" content="Cet article montre comment abuser de la délégation complète (Unconstrained Delegation) afin de récupérer le TGT d’un utilisateur, permettant ainsi de s’authentifier auprès de n’importe quel service en son nom." />
<link rel="canonical" href="http://localhost:4000/unconstrained-delegation-attack/" />
<meta property="og:url" content="http://localhost:4000/unconstrained-delegation-attack/" />
<meta property="og:site_name" content="hackndo" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-12T13:28:42+02:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icones/logo.png"},"name":"Pixis"},"url":"http://localhost:4000/unconstrained-delegation-attack/","headline":"Unconstrained Delegation - Risques","dateModified":"2019-04-12T13:28:42+02:00","datePublished":"2019-04-12T13:28:42+02:00","author":{"@type":"Person","name":"Pixis"},"description":"Cet article montre comment abuser de la délégation complète (Unconstrained Delegation) afin de récupérer le TGT d’un utilisateur, permettant ainsi de s’authentifier auprès de n’importe quel service en son nom.","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/unconstrained-delegation-attack/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <header class="cd-main-header">
    <a href="/" class="cd-logo"><img src="/assets/icones/logo.png" /> <span class="cd-logo-title">hackndo</span></a>
		
    <a href="#0" class="cd-nav-trigger">Menu<span></span></a>

</header> <!-- .cd-main-header -->
    <main class="cd-main-content">
		<nav class="cd-side-nav">
            <div class="sidebar-about">
    <h1>
        <img id="site-logo" src="/assets/icones/logo.png" alt="logo" title="logo" />
        <a class="sidebar-title" href="/">
        hackndo
        </a>
    </h1>
    <p class="lead">Think out of the box</p>
</div>

<ul>
    <li class="cd-label">Blog</li>
    <li class="">
        <a href="/">Home</a>
    </li>
    
    
        
            
        
    
        
            
                <li class="">
                    <a href="/about/">À propos</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/archives/">Archives</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/contact/">Me contacter</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/disclaimer/">Disclaimer</a>
                </li>
            
        
    
        
    
        
            
        
    
        
            
                <li class="">
                    <a href="/projects/">Projets</a>
                </li>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
    
        
    
</ul>
<ul>
    <li class="cd-label">Liens</li>
    <li><a href="https://www.dailysecurity.fr/" target="_blank">Blog de Geluchat</a></li>
    <li><a href="http://lsdsecdaemon.com" target="_blank">Blog de Th3_l5D</a></li>
    <li><a href="http://inf0sec.fr" target="_blank">Blog de Matthieu</a></li>
</ul>
<p class="sidebar-copyright">&copy; 2019. Tous droits réservés.</p>
<div class="sidebar-social">
<ul>
  <li><a href="https://twitter.com/HackAndDo" title="Twitter" target="_blank"><img alt="Twitter" title="Twitter" src="/assets/icones/social/twitter.png" /></a></li>
  <li><a href="https://github.com/hackndo" title="Github" target="_blank"><img title="Github" alt="Github" src="/assets/icones/social/github.png" /></a></li>
  <li><a href="https://www.youtube.com/channel/UC9WYWHLdu9TK-0Hu3wcHJ9g" title="Youtube" target="_blank"><img title="Youtube" alt="Youtube" src="/assets/icones/social/youtube.png" /></a></li>
  <li><a href="https://discord.gg/9At6SUZ" title="Discord" target="_blank"><img title="Discord" alt="Discord" src="/assets/icones/social/discord.png" /></a></li>
  <li><a href="https://www.linkedin.com/in/romainbentz/" title="LinkedIn" target="_blank"><img title="LinkedIn" alt="LinkedIn" src="/assets/icones/social/linkedin.png" /></a></li>
  <li><a href="https://sh.hackndo.com" title="Shell" target="_blank"><img title="Shell" alt="Shell" src="/assets/icones/social/shell.png" /></a></li>
  <li><a href="/feed.xml" title="RSS" target="_blank"><img title="RSS" alt="RSS" src="/assets/icones/social/rss.png" /></a></li>
  <li><a href="https://ko-fi.com/hackndo" title="Ko-Fi" target="_blank"><img title="Ko-Fi" alt="Ko-Fi" src="/assets/icones/social/kofi.gif" /></a></li>
</ul>
</div>
        </nav>

        <div class="content-wrapper">
            <div class="post">
  
  <div class="post-cover">
    <img src="/assets/uploads/2019/04/unconstrained_admin.png" alt="Unconstrained Delegation - Risques" title="Unconstrained Delegation - Risques" />
  </div>
  
  <h1 class="post-title">Unconstrained Delegation - Risques</h1>
  <div class="post-info">
      <p class="alignleft">12 Apr 2019 <a class="post-comments-count" href="http://http://localhost:4000/unconstrained-delegation-attack/#disqus_thread"></a></p>
      <p class="alignright">Auteur : <strong><a href="https://twitter.com/HackAndDo">Pixis</a></strong></p>
      <div class="keywords">
        <span class="post-tags"><a href="/archives/#active-directory"><i class="fas fa-tags"></i> Active Directory</a><a href="/archives/#windows"><i class="fas fa-tags"></i> Windows</a></span>
      </div>
</div>

  <article>
  <p>Suite à l’article sur la <a href="/constrained-unconstrained-delegation">délégation Kerberos</a>, nous allons maintenant voir comment abuser de la délégation complète (Unconstrained Delegation) afin de récupérer le TGT d’un utilisateur, nous permettant ainsi de nous authentifier auprès de n’importe quel service en son nom.</p>

<!--more-->

<h2 id="rappels--unconstrained-delegation">Rappels : Unconstrained Delegation</h2>

<p>Comme nous l’avons vu dans l’article sur la <a href="/constrained-unconstrained-delegation">délégation Kerberos</a>, lorsqu’un compte possède le drapeau “Unconstrained Delegation” (<code class="highlighter-rouge">ADS_UF_TRUSTED_FOR_DELEGATION</code>), si les informations d’authentification de l’utilisateur faisant une demande de TGS pour un service proposé par ce compte peuvent être relayées, alors le contrôleur de domaine va répondre à l’utilisateur avec un <a href="/kerberos/#krb_tgs_req">KRB_TGS_REQ</a> contenant les informations classiques telles que le TGS, mais il va également intégrer dans sa réponse <strong>une copie du TGT</strong> de l’utilisateur, ainsi qu’une nouvelle clé de session associée.</p>

<p><a href="/assets/uploads/2019/02/cop_tgt.png"><img src="/assets/uploads/2019/02/cop_tgt.png" alt="Unconstrained Delegation" /></a></p>

<p>Concrètement, le compte de service qui recevra ce TGS <strong>aura aussi une copie du TGT de l’utilisateur</strong>, ainsi qu’une clé de session valide pour utiliser ce TGT.</p>

<h2 id="exploitation">Exploitation</h2>

<p>Cela signifie que maintenant, avec ces informations, le service peut demander n’importe quel TGS au nom de l’utilisateur. Je répète : il peut demander <strong>n’importe. quel. TGS. au nom de l’utilisateur</strong>. Il peut se faire passer pour l’utilisateur pour s’authentifier auprès de n’importe quel service.</p>

<p><a href="/assets/uploads/2019/02/unconstrained_delegation_schema.png"><img src="/assets/uploads/2019/02/unconstrained_delegation_schema.png" alt="Unconstrained Delegation" /></a></p>

<p>Du coup, si l’utilisateur en question possède des droits d’administration pour certaines tâches, le service qui possède maintenant une copie du TGT de cet utilisateur possède également des droits d’administration pour ces tâches. Par exemple, sur ce schéma, un utilisateur est administrateur local d’un contrôleur de domaine. Cet utilisateur se connecte au serveur compromis qui est en “Unconstrained Delegation”.</p>

<p><a href="/assets/uploads/2019/04/unconstrained_admin.png"><img src="/assets/uploads/2019/04/unconstrained_admin.png" alt="Unconstrained Delegation" /></a></p>

<p>Et bien l’attaquant possède maintenant une copie du TGT de cet utilisateur, et peut se faire passer pour lui auprès du contrôleur de domaine, donc être administrateur local de celui-ci.</p>

<p>Ainsi, les comptes ayant la délégation complète sont des cibles prioritaires pour les attaquants, puisqu’une fois un de ces comptes compromis, il suffit d’attendre des authentifications d’utilisateurs pour pouvoir s’authentifier n’importe où en leur nom. Si un administrateur de domaine s’authentifie auprès d’un service proposé par ce compte, alors l’attaquant a gagné, le domaine est totalement compromis.</p>

<h2 id="par-lexemple">Par l’exemple</h2>

<p>Nous allons ici présenter un exemple qui a été effectué dans mon lab, ADSEC. Il y a ici la machine <code class="highlighter-rouge">WEB-SERVER-01</code> qui est en “Unconstrained Delegation”.</p>

<p><a href="/assets/uploads/2019/04/server_01_unconstrained.png"><img src="/assets/uploads/2019/04/server_01_unconstrained.png" alt="Unconstrained Delegation" /></a></p>

<p>Il est possible de s’authentifier auprès de cette machine pour utiliser ses partages réseau. Nous imaginons qu’un attaquant ait réussi à compromettre cette machine, et qu’il est administrateur local de cette machine.</p>

<p>L’attaquant doit alors attendre qu’un utilisateur à privilèges se connecte sur la machine. Il va donc monitorer les connexions et inspecter les TGS afin de voir si un TGT est présent dans l’un deux. Pour cela, il utilise l’outil <a href="https://github.com/GhostPack/Rubeus">Rubeus</a> développé par <a href="https://twitter.com/harmj0y">@Harmj0y</a>. (D’autres outils existent tels que <a href="https://github.com/gentilkiwi/kekeo/">kekeo</a> de <a href="https://twitter.com/gentilkiwi">@gentilkiwi</a> par exemple.)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\Rubeus monitor /interval:5
</code></pre></div></div>

<p><a href="/assets/uploads/2019/04/wait_for_connexion.png"><img src="/assets/uploads/2019/04/wait_for_connexion.png" alt="Rubeus Monitor" /></a></p>

<p>Il se trouve qu’à un moment donné, le compte <code class="highlighter-rouge">support-account</code>, <strong>administrateur de domaine</strong>, doit aller voir quelque chose sur le disque dur de <code class="highlighter-rouge">WEB-SERVER-01</code>. Pour cela, il se connecte au partage réseau du serveur <code class="highlighter-rouge">\\WEB-SERVER-01\c$</code>.</p>

<p><a href="/assets/uploads/2019/04/connexion_from_domain_admin.png"><img src="/assets/uploads/2019/04/connexion_from_domain_admin.png" alt="Connexion from DA" /></a></p>

<p>Cette connexion est détectée par Rubeus, puisqu’un événement <a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4624">4624</a> (Successful logon) est généré dans le journal d’événements de <code class="highlighter-rouge">WEB-SERVER-01</code>. Comme cette machine est en “Unconstrained Delegation”, le TGS envoyé par l’administrateur de domaine contient une copie de son TGT, copie qui va être extrait par Rubeus.</p>

<p><a href="/assets/uploads/2019/04/connexion_success.png"><img src="/assets/uploads/2019/04/connexion_success.png" alt="Connexion success on Rubeus" /></a></p>

<p>Maintenant en possession du TGT d’un administrateur de domaine (encodé en base 64 dans cette capture), l’attaquant peut demander un TGS pour utiliser le service LDAP du contrôleur de domaine <code class="highlighter-rouge">DC-01</code>. Rubeus permet de faire cette requête.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\Rubeus.exe asktgs /ticket:&lt;ticket en base64&gt; /service:ldap/dc-01.adsec.local /ptt
</code></pre></div></div>

<p><a href="/assets/uploads/2019/04/get_ldap_tgs.png"><img src="/assets/uploads/2019/04/get_ldap_tgs.png" alt="Get LDAP TGS" /></a></p>

<p>Tout fonctionne comme prévu, nous pouvons vérifier la présence du TGS en mémoire, pour l’utilisateur <code class="highlighter-rouge">support-account</code> (puisque l’attaquant a utilisé son TGT), et pour le service LDAP du contrôleur de domaine.</p>

<p><a href="/assets/uploads/2019/04/get_ldap_tgs_success.png"><img src="/assets/uploads/2019/04/get_ldap_tgs_success.png" alt="Get LDAP TGS" /></a></p>

<p>Avec ce TGS, il est possible de demander au contrôleur de domaine de se synchroniser avec l’attaquant. Ici, l’attaquant a uniquement demandé de synchroniser le compte <code class="highlighter-rouge">krbtgt</code> en vue de faire un “Golden Ticket”.</p>

<p><a href="/assets/uploads/2019/04/dc_sync.png"><img src="/assets/uploads/2019/04/dc_sync.png" alt="DCSync" /></a></p>

<p>Avec le hash NT du compte <code class="highlighter-rouge">krbtgt</code>, l’attaquant peut tout faire sur l’Active Directory.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Cette démonstration montre l’impact immense que peut avoir la compromission d’une machine en “Unconstrained Delegation”. C’est pourquoi ces machines doivent être surveillées, mais devraient surtout être en <a href="/constrained-unconstrained-delegation/#kerberos-constrained-delegation---kcd">Constrained Delegation</a> afin de maitriser les services auxquels elles peuvent se connecter lors de la délégation d’authentification. Par ailleurs, les comptes sensibles devraient avoir l’option “Account is sensitive and cannot be delegated” d’activée, ce qui n’était pas le cas dans l’exemple précédent.</p>

<p><a href="/assets/uploads/2019/04/account_sensitive.png"><img src="/assets/uploads/2019/04/account_sensitive.png" alt="DCSync" /></a></p>

<p>Si l’option est activée pour ce compte, alors le contrôleur de domaine saura qu’aucun service n’aura le droit de relayer les informations d’authentification de cet utilisateur. Ainsi, concernant la délégation complète, le contrôleur de domaine ne vas pas inclure une copie du TGT lors de la demande de TGS.</p>

<p>Il y aura toujours un événement 4624 sur le serveur, mais aucune copie de TGT ne sera disponible.</p>

<p><a href="/assets/uploads/2019/04/no_ticket.png"><img src="/assets/uploads/2019/04/no_ticket.png" alt="DCSync" /></a></p>

<p>J’espère que cet article vous a plu, si vous avez des remarques ou des questions, n’hésitez pas à les poser ici ou sur <a href="https://discord.gg/9At6SUZ" target="blank">Discord</a>. Vous pouvez toujours suivre la sortie de nouveaux articles sur mon twitter <a href="https://twitter.com/HackAndDo" target="blank">@hackanddo</a>.</p>

  </article>
</div>
<div class="keywords">
    <span class="post-tags"><a href="/archives/#active-directory"><i class="fas fa-tags"></i> Active Directory</a><a href="/archives/#windows"><i class="fas fa-tags"></i> Windows</a></span>
  </div>


<br />
<div class="box">
  <div class="dash">
    <div class="picture">
      <img src="/assets/icones/pixis_logo.png" alt="logo" title="logo" />
    </div>
    <div class="box_content">
      <strong>Auteur</strong> : <a href="/contact/" target="_blank">Pixis</a><br />
      Créateur du blog, suivez-moi sur <a href="https://twitter.com/HackAndDo/" target="_blank">twitter</a> ou <a href="https://discord.gg/9At6SUZ" target="blank">discord</a>
    </div>
    
  </div>
</div>


<div class="related">
  <h2>Articles similaires</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/pass-the-hash/">
            Pass the Hash
            <small>18 Dec 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/remote-lsass-dump-passwords/">
            Extraction des secrets de lsass à distance
            <small>28 Nov 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/bloodhound/">
            BloodHound
            <small>30 Jul 2019</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    
    var disqus_config = function () {
        this.page.url = 'http://localhost:4000/unconstrained-delegation-attack/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '0000-0000-0000-00ac';
    };
    
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//hackndo.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        </div>
    </main>
    <script src="/assets/js/jquery-2.1.4.js"></script>
    <script src="/assets/js/jquery.menu-aim.js"></script>
    <script src="/assets/js/anchor.min.js"></script>
    <script src="/assets/js/main.js"></script> <!-- Resource jQuery -->
  </body>
</html>