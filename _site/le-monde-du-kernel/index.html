<!doctype html>
<html lang="fr-fr" class="no-js">

  <head>
    <link href="http://gmpg.org/xfn/11" rel="profile" hreflang="fr">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
    <meta name="google-site-verification" content="JeRPv2CEcpONAy8C7dMr1nzjlpZxlxYCtt2PnuQ78g8" />
    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  
    <title>
      
        Le monde du kernel - hackndo
      
    </title>

	<link rel="stylesheet" href="/assets/css/style.css?v=1.13"> <!-- Resource style -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Signika:600"> <!-- Logo font -->
    <script src="/assets/js/modernizr.js"></script> <!-- Modernizr -->
    
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/icones/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/icones/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/icones/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/icones/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/icones/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/icones/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/icones/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icones/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icones/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icones/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icones/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/icones/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icones/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/res/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/icones/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
  	
	<!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hackndo" />

    <!-- Twitter card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@hackanddo" />
    <meta name="twitter:creator" content="@hackanddo" />
    <meta name="twitter:title" content="Le monde du kernel" />
    <meta name="twitter:description" content="Lorsque vous utilisez votre ordinateur tous les jours, en allant sur internet, en regardant des films, ou encore en codant, une grosse machinerie est en route pour vous simplifier la vie." />
    
    <meta name="twitter:image" content="http://localhost:4000/assets/uploads/2016/07/kernel_1.jpg" />
    
  
    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  
      ga('create', 'UA-80312745-1', 'auto');
      ga('send', 'pageview');
  
    </script>
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Le monde du kernel" />
<meta name="author" content="Pixis" />
<meta property="og:locale" content="fr_FR" />
<meta name="description" content="Lorsque vous utilisez votre ordinateur tous les jours, en allant sur internet, en regardant des films, ou encore en codant, une grosse machinerie est en route pour vous simplifier la vie." />
<meta property="og:description" content="Lorsque vous utilisez votre ordinateur tous les jours, en allant sur internet, en regardant des films, ou encore en codant, une grosse machinerie est en route pour vous simplifier la vie." />
<link rel="canonical" href="http://localhost:4000/le-monde-du-kernel/" />
<meta property="og:url" content="http://localhost:4000/le-monde-du-kernel/" />
<meta property="og:site_name" content="hackndo" />
<meta property="og:image" content="http://localhost:4000/assets/uploads/2016/07/kernel_1.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-07-05T19:48:43+02:00" />
<script type="application/ld+json">
{"image":"http://localhost:4000/assets/uploads/2016/07/kernel_1.jpg","@type":"BlogPosting","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icones/logo.png"},"name":"Pixis"},"url":"http://localhost:4000/le-monde-du-kernel/","headline":"Le monde du kernel","dateModified":"2016-07-05T19:48:43+02:00","datePublished":"2016-07-05T19:48:43+02:00","author":{"@type":"Person","name":"Pixis"},"description":"Lorsque vous utilisez votre ordinateur tous les jours, en allant sur internet, en regardant des films, ou encore en codant, une grosse machinerie est en route pour vous simplifier la vie.","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/le-monde-du-kernel/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <header class="cd-main-header">
    <a href="/" class="cd-logo"><img src="/assets/icones/logo.png" /> <span class="cd-logo-title">hackndo</span></a>
		
    <a href="#0" class="cd-nav-trigger">Menu<span></span></a>

</header> <!-- .cd-main-header -->
    <main class="cd-main-content">
		<nav class="cd-side-nav">
            <div class="sidebar-about">
    <h1>
        <img id="site-logo" src="/assets/icones/logo.png" alt="logo" title="logo" />
        <a class="sidebar-title" href="/">
        hackndo
        </a>
    </h1>
    <p class="lead">Think out of the box</p>
</div>

<ul>
    <li class="cd-label">Blog</li>
    <li class="">
        <a href="/">Home</a>
    </li>
    
    
        
            
        
    
        
            
                <li class="">
                    <a href="/about/">À propos</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/archives/">Archives</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/contact/">Me contacter</a>
                </li>
            
        
    
        
            
                <li class="">
                    <a href="/disclaimer/">Disclaimer</a>
                </li>
            
        
    
        
    
        
            
        
    
        
            
                <li class="">
                    <a href="/projects/">Projets</a>
                </li>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
    
        
    
</ul>
<ul>
    <li class="cd-label">Liens</li>
    <li><a href="https://www.dailysecurity.fr/" target="_blank">Blog de Geluchat</a></li>
    <li><a href="http://lsdsecdaemon.com" target="_blank">Blog de Th3_l5D</a></li>
    <li><a href="http://inf0sec.fr" target="_blank">Blog de Matthieu</a></li>
</ul>
<p class="sidebar-copyright">&copy; 2019. Tous droits réservés.</p>
<div class="sidebar-social">
<ul>
  <li><a href="https://twitter.com/HackAndDo" title="Twitter" target="_blank"><img alt="Twitter" title="Twitter" src="/assets/icones/social/twitter.png" /></a></li>
  <li><a href="https://github.com/hackndo" title="Github" target="_blank"><img title="Github" alt="Github" src="/assets/icones/social/github.png" /></a></li>
  <li><a href="https://www.youtube.com/channel/UC9WYWHLdu9TK-0Hu3wcHJ9g" title="Youtube" target="_blank"><img title="Youtube" alt="Youtube" src="/assets/icones/social/youtube.png" /></a></li>
  <li><a href="https://discord.gg/9At6SUZ" title="Discord" target="_blank"><img title="Discord" alt="Discord" src="/assets/icones/social/discord.png" /></a></li>
  <li><a href="https://www.linkedin.com/in/romainbentz/" title="LinkedIn" target="_blank"><img title="LinkedIn" alt="LinkedIn" src="/assets/icones/social/linkedin.png" /></a></li>
  <li><a href="https://sh.hackndo.com" title="Shell" target="_blank"><img title="Shell" alt="Shell" src="/assets/icones/social/shell.png" /></a></li>
  <li><a href="/feed.xml" title="RSS" target="_blank"><img title="RSS" alt="RSS" src="/assets/icones/social/rss.png" /></a></li>
  <li><a href="https://ko-fi.com/hackndo" title="Ko-Fi" target="_blank"><img title="Ko-Fi" alt="Ko-Fi" src="/assets/icones/social/kofi.gif" /></a></li>
</ul>
</div>
        </nav>

        <div class="content-wrapper">
            <div class="post">
  
  <div class="post-cover">
    <img src="/assets/uploads/2016/07/kernel_1.jpg" alt="Le monde du kernel" title="Le monde du kernel" />
  </div>
  
  <h1 class="post-title">Le monde du kernel</h1>
  <div class="post-info">
      <p class="alignleft">05 Jul 2016 <a class="post-comments-count" href="http://http://localhost:4000/le-monde-du-kernel/#disqus_thread"></a></p>
      <p class="alignright">Auteur : <strong><a href="https://twitter.com/HackAndDo">Pixis</a></strong></p>
      <div class="keywords">
        <span class="post-tags"><a href="/archives/#kernel-land"><i class="fas fa-tags"></i> Kernel Land</a><a href="/archives/#linux"><i class="fas fa-tags"></i> Linux</a></span>
      </div>
</div>

  <article>
  <p>Bonjour à tous. Aujourd’hui, je commence une série d’articles qui va concerner le monde du kernel. Je signale maintenant que le livre “A guide to kernel exploitation - Exploiting the core” est la source principale de cette série.</p>

<p>Je l’ai lu en long, large et travers, mais il est en anglais et relativement long, donc je tente ici d’en faire une synthèse claire et digérable en français pour en faire profiter le plus de monde. J’espère qu’à la suite de cette lecture, vous aurez une compréhension suffisamment globale et profonde des rouages du kernel pour passer la barrière du copier/coller lors de lectures de tutoriaux pratiques.</p>

<p>Je ne me contente évidemment pas d’un simple résumé, je tente le plus possible d’ajouter des schémas ou des exemples pour rendre cette série la plus agréable à lire possible.</p>

<!--more-->

<h2 id="introduction">Introduction</h2>

<p>Lorsque vous utilisez votre ordinateur tous les jours, en allant sur internet, en regardant des films, ou encore en codant, une grosse machinerie est en route pour vous simplifier la vie. Pour utiliser votre wifi ou écouter de la musique, il faut à un moment donné communiquer avec le matériel, et pourtant vous n’avez pas besoin de connaitre le constructeur de votre carte réseau, ni celui de votre carte son. Si c’est possible, c’est parce que vous utilisez un système d’exploitation (ou OS, Operating System) qui sert de couche d’abstraction pour ces différentes contraintes. Et le coeur de l’OS est ce qu’on appelle le noyau (kernel).</p>

<p>Le schéma suivant résume de manière très macro ce découpage.</p>

<p><a href="/assets/uploads/2016/06/Screen-Shot-2016-06-14-at-23.20.15.png"><img src="/assets/uploads/2016/06/Screen-Shot-2016-06-14-at-23.20.15.png" alt="Screen-Shot-2016-06-14-at-23.20.15" /></a></p>

<p>En général, le kernel est la partie qui comprend essentiellement ce qui est critique au bon fonctionnement de la machine comme l’accès au matériel, la gestion des ressources ou la sécurité. L’OS quant à lui regroupe le kernel et les programmes/bibliothèques qui sont au dessus, le <em>runtime</em>, comme la libc sous linux, le binaire <em>init</em> etc.</p>

<p>Pour travailler sereinement et de manière sûre, le kernel a besoin de poser des barrières entre les actions critiques et les autres. Pour cela, il le fait au niveau matériel et au niveau logiciel.</p>

<ul>
  <li>Au niveau <strong>matériel</strong>, la majorité des CPU ont des jeux d’instruction qui proposent deux modes d’exécution. Le premier est un mode privilégié dans lequel toutes les instructions sont disponibles tandis que le second est un mode non privilégié, ne donnant accès qu’à une partie des instructions.</li>
  <li>Au niveau <strong>logiciel</strong>, le kernel s’arrange pour avoir accès aux plages mémoires de tous les processus en cours d’exécution, tout en interdisant l’accès de sa propre plage mémoire aux autre processus. La plage mémoire du kernel est appelée Kernel-Land, tandis que la plage mémoire que voit chaque processus est appelée User-Land</li>
</ul>

<p>Biensûr, ces protections, bien que nécessaires, ne sont pas toujours suffisantes. De nos jours, tous les systèmes informatiques sont multi-utilisateurs et multi-tâches. Il ne faut par exemple pas qu’un utilisateur puisse s’accaparer toute la mémoire, ou toute la bande passante. Il faut également qu’il y ait la possibilité d’ajouter, supprimer ou modifier des utilisateurs, ou encore la possibilité de modifier le kernel pour le mettre à jour par exemple. Pour répondre à ces besoins, tous les utilisateurs ont un identifiant unique appelé UID (User ID), mais il y a un UID qui est spécial, et qui permet d’avoir des droits plus élevés que tous les autres. C’est celui de l’administrateur chez windows, ou du root chez Unix, généralement le 0. Cet utilisateur peut souvent modifier le kernel, toujours gérer les utilisateurs etc. C’est le tout puissant, c’est celui qu’on veut usurper quand il en vient à l’exploitation d’un système.</p>

<h2 id="pourquoi-le-kernel-">Pourquoi le kernel ?</h2>

<p>Depuis longtemps, les attaquants se concentrent sur le User-Land, ce qui a logiquement entrainé la prise de mesures de sécurité telles que l’ASLR, le canary, les zones NX etc. Le user-land devient de plus en plus protégé. Par ailleurs, une exploitation du kernel donne plus de droit à l’attaquant. Ça parait donc logique que l’attention des attaquants se tourne vers le kernel.</p>

<p>Cependant écrire des exploits pour profiter de vulnérabilités dans le kernel n’est pas aussi simple que dans le User-Land. En effet, s’il y a une erreur dans le User-Land, l’application crash. S’il y a une erreur dans le Kernel-Land, le kernel crash. Et le kernel, c’est le coeur de l’OS, donc s’il crash, la machine peut ne plus fonctionner et s’éteindre. Et ça, c’est balo, parce qu’on ne peut plus rien faire. Par ailleurs, nous avons dit que le kernel était protégé de manière matérielle et logicielle, donc il est plus compliqué de trouver des infos, d’autant plus que TOUS les processus en cours affectent l’état du kernel, donc l’arrangement mémoire du kernel-land change rapidement, pas simple. Enfin, le kernel est extrêmement gros et complexe, donc l’attaquant doit comprendre beaucoup de méchanismes pour trouver puis exploiter des vulnérabilités.</p>

<h2 id="quelles-sont-les-vulnérabilités-du-kernel-">Quelles sont les vulnérabilités du kernel ?</h2>

<p>Sans être exhaustif, il existe différentes vulnérabilités.</p>

<p>Le kernel est responsable de l’ordonnancement (<em>scheduling</em>) des différentes tâches pour simuler un comportement multi-tâches. Nous ne rentrerons pas dans les détails de l’ordonnancement, mais le fait que le kernel bascule d’une tâche à l’autre permet l’utilisation de <em>race conditions</em> (contidions de concurrence). C’est à dire qu’entre deux instructions peut s’écouler un temps plus ou moins long, et pour peu que la première instruction soit une vérification sur des droits et que la deuxième soit une action si les droits sont vérifiés, il est possible de modifier des éléments entre la vérification et l’action prise, pour que l’action s’effectue sur autre chose que prévu.</p>

<p>Par ailleurs, pour passer d’un processus à l’autre, le kernel doit mémoriser des informations telles que les fichiers ouverts, les droits du processus, et quelles pages mémoires sont utilisées par celui-ci. Si nous trouvons où sont stockées ces infos et que nous les modifions, ça peut devenir intéressant.</p>

<p>Ensuite, le kernel est responsable de la gestion de la mémoire virtuelle. L’article sur <a href="/gestion-de-la-memoire/">la gestion de la mémoire</a> en parle rapidement, mais ajoutons ici quelques informations et termes. La mémoire physique est divisée en <em>frames</em>, et la mémoire virtuelle en <em>pages</em>. Lorsqu’un processus a besoin d’espace mémoire, il demande à la mémoire physique de lui allouer des <em>pages</em>. C’est la table de pages qui fait le lien entre les <em>pages</em> et les <em>frames</em>, avec une table de pages par processus.</p>

<p><a href="/assets/uploads/2016/06/Screen-Shot-2016-07-05-at-20.56.49.png"><img src="/assets/uploads/2016/06/Screen-Shot-2016-07-05-at-20.56.49.png" alt="Screen-Shot-2016-07-05-at-20.56.49" /></a></p>

<p>Oui, il y a beaucoup de flèches. L’idée, c’est de montrer qu’à gauche, côté mémoire virtuelle, nous avons les <em>pages</em> qui trouvent leur emplacement grace aux tables de pages qui font la traduction avec la mémoire physique découpée en <em>frames</em>.</p>

<p>Deux implémentations existent pour la séparation des pages allouées entre kernel et utilisateur.</p>

<ul>
  <li>La première, c’est que la plage de mémoire virtuelle attribuée à un processus est <strong>partagée</strong>. Une partie pour le processus, l’autre partie pour le kernel. Pour cela, les entrées de la table de page du kernel sont répliquées dans la table de page du processus. C’est cette implémentation qui a été représentée dans le schéma précédent.</li>
  <li>La seconde, c’est que le kernel et le processus ont tous les deux une <strong>zone mémoire complète et indépendente</strong>.</li>
</ul>

<p>Schématiquement, ça donne donc ceci :</p>

<p><a href="/assets/uploads/2016/06/Screen-Shot-2016-06-14-at-23.30.17.png"><img src="/assets/uploads/2016/06/Screen-Shot-2016-06-14-at-23.30.17.png" alt="Screen-Shot-2016-06-14-at-23.30.17" /></a></p>

<p>Mais si vous souhaitez un peu plus de détails, alors ça ressemble un peu plus à cela</p>

<p><a href="/assets/uploads/2016/06/Screen-Shot-2016-07-05-at-22.39.32.png"><img src="/assets/uploads/2016/06/Screen-Shot-2016-07-05-at-22.39.32.png" alt="Screen-Shot-2016-07-05-at-22.39.32" /></a></p>

<p>La première implémentation est la plus intéressante. En effet, le CPU peut avoir deux contextes d’exécution.</p>

<p>Le premier contexte d’exécution, qui ne nous intéresse pas vraiment, est le mode superviseur. C’est lorsqu’aucun processus n’est attaché au contexte. Ça arrive par exemple avec des interruptions réseau ou disque.</p>

<p>Mais dans le deuxième, le contexte processus (<em>process context</em>), un processus est associé, appelé le <em>backing process</em>, ce qui signifie que quelque part dans le kernel se trouvent les infos du processus en cours, et ça c’est cool pour nous. Comme on controle le <em>backing process</em>, on contrôle le user-land. Et comme on est dans le cas où la plage mémoire est partagée avec le kernel-land, si on trouve une faille dans le kernel, on peut rediriger le flot d’exécution dans le user-land, qu’on contrôle. Parfait! Voici un petit schéma qui illustre ces propos :</p>

<p><a href="/assets/uploads/2016/06/Screen-Shot-2016-07-05-at-21.28.07.png"><img src="/assets/uploads/2016/06/Screen-Shot-2016-07-05-at-21.28.07.png" alt="Screen-Shot-2016-07-05-at-21.28.07" /></a></p>

<p>Comme la mémoire du kernel est répliquée pour tous les processus, on peut créer notre processus à nous. On peut alors exploiter la vulnérabilité dans le kernel qui nous permet de rediriger le flot d’exécution du kernel vers une partie de code qu’on a préparée. Il suffit alors que ce code change les infos de notre processus en cours pour lui donner des droits plus élevés, et le tour est joué.</p>

<hr />

<p>Alors, prêts à plonger dans ce nouveau monde ? La suite avec <a href="/les-failles-kernel">les failles kernel</a></p>

  </article>
</div>
<div class="keywords">
    <span class="post-tags"><a href="/archives/#kernel-land"><i class="fas fa-tags"></i> Kernel Land</a><a href="/archives/#linux"><i class="fas fa-tags"></i> Linux</a></span>
  </div>


<br />
<div class="box">
  <div class="dash">
    <div class="picture">
      <img src="/assets/icones/pixis_logo.png" alt="logo" title="logo" />
    </div>
    <div class="box_content">
      <strong>Auteur</strong> : <a href="/contact/" target="_blank">Pixis</a><br />
      Créateur du blog, suivez-moi sur <a href="https://twitter.com/HackAndDo/" target="_blank">twitter</a> ou <a href="https://discord.gg/9At6SUZ" target="blank">discord</a>
    </div>
    
  </div>
</div>


<div class="related">
  <h2>Articles similaires</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/pass-the-hash/">
            Pass the Hash
            <small>18 Dec 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/remote-lsass-dump-passwords/">
            Extraction des secrets de lsass à distance
            <small>28 Nov 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/bloodhound/">
            BloodHound
            <small>30 Jul 2019</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    
    var disqus_config = function () {
        this.page.url = 'http://localhost:4000/le-monde-du-kernel/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '0000-0000-0000-0013';
    };
    
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//hackndo.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        </div>
    </main>
    <script src="/assets/js/jquery-2.1.4.js"></script>
    <script src="/assets/js/jquery.menu-aim.js"></script>
    <script src="/assets/js/anchor.min.js"></script>
    <script src="/assets/js/main.js"></script> <!-- Resource jQuery -->
  </body>
</html>